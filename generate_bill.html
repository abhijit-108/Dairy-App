<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Bill Auto Genarated</title>

    <!-- === Loading screen CSS (extracted & self-contained) === -->
    <style>
        :root {
            --bg-a: #667eea;
            --bg-b: #764ba2;
            --bg-c: #f093fb;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #loadingScreen {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--bg-a) 0%, var(--bg-b) 50%, var(--bg-c) 100%);
            background-size: 400% 400%;
            animation: gradientShift 6s ease infinite;
            z-index: 99999;
            transition: opacity .8s ease-out, visibility .8s ease-out;
            overflow: hidden;
        }

        #loadingScreen.fade-out {
            opacity: 0;
            visibility: hidden;
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%
            }

            50% {
                background-position: 100% 50%
            }

            100% {
                background-position: 0% 50%
            }
        }

        .particles {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, .6);
            border-radius: 50%;
            animation: float 8s infinite linear;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0
            }

            10% {
                opacity: 1
            }

            90% {
                opacity: 1
            }

            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0
            }
        }

        .loading-container {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 32px;
            background: rgba(255, 255, 255, .08);
            backdrop-filter: blur(18px);
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, .16);
            box-shadow: 0 20px 40px rgba(0, 0, 0, .12);
            animation: containerPulse 2s ease-in-out infinite alternate;
        }

        @keyframes containerPulse {
            0% {
                transform: scale(1) translateY(0)
            }

            100% {
                transform: scale(1.02) translateY(-5px)
            }
        }

        .loading-spinner {
            width: 72px;
            height: 72px;
            position: relative;
            margin-bottom: 22px;
        }

        .spinner-ring {
            position: absolute;
            border: 3px solid transparent;
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }

        .spinner-ring:nth-child(1) {
            width: 72px;
            height: 72px;
            border-top: 3px solid #fff;
            border-right: 3px solid #fff;
            animation-duration: 2s;
        }

        .spinner-ring:nth-child(2) {
            width: 52px;
            height: 52px;
            top: 10px;
            left: 10px;
            border-bottom: 3px solid rgba(255, 255, 255, .85);
            border-left: 3px solid rgba(255, 255, 255, .85);
            animation-duration: 1.5s;
            animation-direction: reverse;
        }

        .spinner-ring:nth-child(3) {
            width: 32px;
            height: 32px;
            top: 20px;
            left: 20px;
            border-top: 3px solid rgba(255, 255, 255, .6);
            border-right: 3px solid rgba(255, 255, 255, .6);
            animation-duration: 1s;
        }

        @keyframes spin {
            0% {
                transform: rotate(0)
            }

            100% {
                transform: rotate(360deg)
            }
        }

        .loading-text {
            color: #fff;
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 8px;
            text-shadow: 0 2px 8px rgba(0, 0, 0, .25);
            letter-spacing: .6px;
        }

        .loading-subtext {
            color: rgba(255, 255, 255, .95);
            font-size: 14px;
            text-align: center;
            font-weight: 400;
            text-shadow: 0 1px 4px rgba(0, 0, 0, .18);
        }

        .progress-container {
            width: 260px;
            height: 6px;
            background: rgba(255, 255, 255, .2);
            border-radius: 6px;
            margin-top: 18px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #fff, rgba(255, 255, 255, .85));
            border-radius: 6px;
            width: 0%;
            transition: width .4s ease;
        }

        @media (max-width:600px) {
            .loading-text {
                font-size: 18px
            }

            .loading-container {
                padding: 22px
            }

            .progress-container {
                width: 200px
            }
        }

        @media (prefers-color-scheme:dark) {
            #loadingScreen {
                background: linear-gradient(135deg, #1a237e 0%, #283593 50%, #512da8 100%);
            }
        }
    </style>

    <!-- === Your original page CSS (unchanged) === -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-top: 0;
            margin-bottom: 10px;
        }

        .date-range-selector {
            margin-bottom: 20px;
            text-align: center;
        }

        .date-range-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .date-btn {
            padding: 6px 10px;
            border: 2px solid #007bff;
            background: white;
            color: #007bff;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .date-btn.active {
            background: #007bff;
            color: white;
        }

        .date-btn:hover {
            background: #0056b3;
            color: white;
        }

        .checkbox-section {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        .billbox-section {
            margin: 0;
            padding: 10px;
            margin-left: auto;
            margin-right: auto;
            max-width: 600px;
            background: #d8ecff;
            border-radius: 5px;
            margin-bottom: 60px;
        }

        .checkbox-section h3 {
            margin-top: 0;
            color: #333;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            font-size: 1rem;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            transform: scale(1.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
        }

        th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            text-align: right;
        }

        .fixed-row {
            background-color: #f9f9f9;
            font-weight: bold;
        }

        .database-row {
            background-color: #f9f9f9;
        }

        .database-row:nth-child(even) {
            background-color: #ffffff;
        }

        .footer-row {
            background-color: #28a745;
            color: white;
            font-weight: bold;
        }

        .numeric {
            text-align: right;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            color: #dc3545;
            text-align: center;
            padding: 12px;
            width: max-content;
            font-size: 0.8rem;
            background: #f8d7da;
            border-radius: 5px;
            margin: 10px 0;
        }

        .refresh-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }

        .refresh-btn:hover {
            background: #218838;
        }

        .download-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 15px auto;
            display: block;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.3s;
        }

        .download-btn:hover {
            background: #138496;
        }

        .download-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        th:first-child,
        td:first-child {
            text-align: left;
        }

        @media (max-width: 768px) {
            .checkbox-section {
                padding: 10px;
            }

            h1 {
                font-size: 1.3rem;
                font-weight: bolder;
            }

            .checkbox-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 5px;
            }

            .checkbox-item {
                font-size: 0.85rem;
            }

            table {
                width: 100%;
                max-width: 600px;
                border-collapse: collapse;
                margin-top: 0;
            }

            th,
            td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }

            th {
                background-color: #007bff;
                color: white;
                padding: 4px;
                font-size: 12px;
                text-align: center;
                font-weight: bold;
            }

            th:first-child {
                text-align: center;
            }

            td:first-child {
                min-width: 100px;
                text-align: left;
            }
        }

        .dated_bill {
            display: inline-block;
            padding: 6px 14px;
            background: #f0f8ff;
            color: #222;
            font-weight: 700;
            margin-bottom: 5px;
            font-size: 17px;
            border: 2px solid #007bff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            letter-spacing: 0.5px;
        }

        #tableContainer {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a1a1a;
                color: #e0e0e0;
            }

            .container {
                background: #2d2d2d;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            }

            h1 {
                color: #e0e0e0;
            }

            .checkbox-section {
                background: #3d3d3d;
            }

            .checkbox-section h3 {
                color: #e0e0e0;
            }

            .billbox-section {
                background: #2c3e50;
                margin: 0;
                padding: 5px;
            }

            table {
                color: #e0e0e0;
            }

            th,
            td {
                border-color: #555;
            }

            .fixed-row {
                background-color: #3d3d3d;
            }

            .database-row {
                background-color: #3d3e3d;
            }

            .database-row:nth-child(even) {
                background-color: #2d2d2d;
            }

            #tableContainer {
                background: #2d2d2d;
                padding: 8px;
            }

            .dated_bill {
                background: #2c3e50;
                color: #e0e0e0;
                border-color: #3498db;
            }
        }

        .responsive-pair {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-start;
        }

        .panel {
            flex: 1 1 320px;
            min-width: 260px;
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            box-sizing: border-box;
        }

        .fixed-left .panel-left {
            flex: 0 0 300px;
            min-width: 200px;
        }

        .fixed-left .panel-right {
            flex: 1 1 0;
            min-width: 200px;
        }

        .responsive-pair,
        .panel {
            max-width: 100%;
        }
    </style>
</head>

<body>

    <!-- Loading screen markup (self-contained) -->
    <div id="loadingScreen" role="status" aria-live="polite" aria-label="Loading content" style="display:flex">
        <div class="particles" id="particles"></div>

        <div class="loading-container" id="loadingContainer">
            <div class="loading-spinner" aria-hidden="true">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>

            <div class="loading-text" id="loadingText">Loading<span class="loading-dots" aria-hidden="true"></span>
            </div>
            <div class="loading-subtext" id="loadingSubtext">Please wait</div>

            <div class="progress-container" aria-hidden="true">
                <div class="progress-bar" id="progressBar"></div>
            </div>
        </div>
    </div>

    <!-- === Page content (unchanged) === -->
    <div class="responsive-pair">
        <div class="panel panel-left">
            <div class="container">
                <h1>Bill Auto Genarated</h1>

                <div class="date-range-selector">
                    <div class="date-range-buttons">
                        <button class="date-btn" data-range="1-7">1-7</button>
                        <button class="date-btn" data-range="8-15">8-15</button>
                        <button class="date-btn" data-range="16-23">16-23</button>
                        <button class="date-btn" data-range="24-rest">24-Rest</button>
                    </div>
                </div>

                <div class="checkbox-section">
                    <h3>Select Names</h3>
                    <div class="checkbox-grid" id="nameCheckboxes">
                        <!-- Checkboxes will be populated here -->
                    </div>
                    <button class="refresh-btn" onclick="loadData()">Refresh Data</button>
                </div>

            </div>
        </div>

        <div class="panel panel-right">

            <div class="billbox-section">
                <div id="errorMessage"></div>

                <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                    <div>
                        <label for="billKg" style="margin-right: 4px;">‡¶Æ‡ßã‡¶ü ‡¶¶‡ßÅ‡¶ß :</label>
                        <input type="number" id="billKg" step="0.01" min="0" value="" onchange="updateTable() "
                            placeholder="0 kg" oninput="updateTable()"
                            style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 70px;font-size: 1.2rem;">
                    </div>
                    <div>
                        <label for="billTotalRupee" style="margin-right:4px;">‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ :</label>
                        <input type="number" id="billTotalRupee" step="0.01" min="0" value="" onchange="updateTable()"
                            placeholder="‚Çπ 0" oninput="updateTable()"
                            style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 70px;font-size: 1.2rem;">
                    </div>
                </div>

                <div id="tableContainer">
                    <div class="dated_bill">
                        <!-- Date range will appear here -->
                    </div>
                    <table id="billTable">
                        <thead>
                            <tr>
                                <th>‡¶®‡¶æ‡¶Æ</th>
                                <th>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (Kg)</th>
                                <th>29 ‡¶ü‡¶æ‡¶ï‡¶æ</th>
                                <th>40.5 ‡¶ü‡¶æ‡¶ï‡¶æ</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr class="loading">
                                <td colspan="4">Loading data...</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="footer-row">
                                <td><strong>Total</strong></td>
                                <td class="numeric" id="totalKg">0.00</td>
                                <td class="numeric" id="totalTakaLess">0.00</td>
                                <td class="numeric" id="totalTakaMain">0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <button class="download-btn" onclick="downloadTableScreenshot()" id="downloadBtn">
                    üì∑ Download Table Screenshot
                </button>
            </div>
        </div>
    </div>

    <!-- Add html2canvas library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- === Loading screen JS (self-contained) === -->
    <script>
        (function () {
            const particlesEl = document.getElementById('particles');
            const loadingScreen = document.getElementById('loadingScreen');
            const loadingTextEl = document.getElementById('loadingText');
            const loadingSubtextEl = document.getElementById('loadingSubtext');
            const progressBarEl = document.getElementById('progressBar');

            function createParticles(count = 30) {
                if (!particlesEl) return;
                particlesEl.innerHTML = '';
                for (let i = 0; i < count; i++) {
                    const p = document.createElement('div');
                    p.className = 'particle';
                    p.style.left = Math.random() * 100 + '%';
                    p.style.animationDelay = (Math.random() * 6) + 's';
                    p.style.animationDuration = (Math.random() * 3 + 5) + 's';
                    p.style.opacity = (Math.random() * 0.6 + 0.2).toFixed(2);
                    particlesEl.appendChild(p);
                }
            }

            function showLoadingScreen(text = 'Loading', subtext = 'Please wait') {
                if (loadingTextEl) loadingTextEl.textContent = text;
                if (loadingSubtextEl) loadingSubtextEl.textContent = subtext;
                if (progressBarEl) progressBarEl.style.width = '0%';
                loadingScreen.classList.remove('fade-out');
                loadingScreen.style.display = 'flex';
            }

            function hideLoadingScreen() {
                loadingScreen.classList.add('fade-out');
                // remove DOM node after fade to avoid blocking interactions
                setTimeout(() => {
                    if (loadingScreen && loadingScreen.classList.contains('fade-out')) {
                        loadingScreen.style.display = 'none';
                    }
                }, 800);
            }

            function setProgress(percent) {
                const val = Math.max(0, Math.min(100, Number(percent) || 0));
                if (progressBarEl) progressBarEl.style.width = val + '%';
            }

            window.LoadingScreen = {
                createParticles,
                show: showLoadingScreen,
                hide: hideLoadingScreen,
                setProgress
            };

            // init particles now so they exist when shown
            createParticles();
        })();
    </script>

    <!-- === Main app script (firebase + page logic) === -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAuhNKygw6dv8jqfNY8qnmIrX-TsLy2jvI",
            authDomain: "dairy-app-abhijit.firebaseapp.com",
            databaseURL: "https://dairy-app-abhijit-default-rtdb.firebaseio.com",
            projectId: "dairy-app-abhijit",
            storageBucket: "dairy-app-abhijit.appspot.com",
            messagingSenderId: "196152880143",
            appId: "1:196152880143:web:bec02170e30932a7d5877a"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase();
        const dbRef = ref(database);

        let currentDateRange = '';
        let allNames = new Set();
        let databaseData = {};

        // Conversion factors
        const conversionFactor_ToMake_original = 40.50 / 29;
        const conversionFactor_ToMake_original_Less = 29 / 40.5;

        // Fixed names always appear first
        const fixedNames = ['‡¶ö‡¶®‡ßç‡¶¶‡¶®‡¶æ ‡¶ò‡ßã‡¶∑.', '‡¶∞‡¶æ‡¶ú‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶ò‡ßã‡¶∑'];

        // Pre-selected names
        const preselectedNames = [
            '‡¶Æ‡¶ß‡ßÅ‡¶Æ‡¶ø‡¶§‡¶æ ‡¶Æ‡¶®‡ßç‡¶°‡¶≤',
            '‡¶∞‡¶ú‡¶ø‡¶®‡¶æ ‡¶∂‡ßá‡¶ñ',
            '‡¶¨‡¶ø‡¶ú‡¶≤‡¶æ ‡¶¶‡ßÅ‡¶≤‡ßá',
            '‡¶∏‡ßÅ‡¶¶‡¶∞‡ßç‡¶∂‡¶® ‡¶ò‡ßã‡¶∑',
            '‡¶Æ‡¶Æ‡¶§‡¶æ ‡¶ò‡ßã‡¶∑',
            '‡¶ù‡¶∞‡ßç‡¶®‡¶æ ‡¶ö‡¶ö‡ßç‡¶ö‡¶°‡¶º‡¶ø',
            '‡¶∏‡ßÅ‡¶≤‡ßã‡¶ö‡¶®‡¶æ ‡¶ò‡ßã‡¶∑',
            '‡¶¨‡ßÅ‡¶≤‡ßç‡¶ü‡¶ø ‡¶¶‡ßÅ‡¶≤‡ßá'
        ];

        // Initialize the page
        window.onload = function () {
            setDefaultDateRange();
            setupEventListeners();
            loadData();
        };

        // --- New: Show formatted range in .dated_bill ---
        function updateDatedBillDisplay() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth(); // 0-based
            let startDay, endDay;

            switch (currentDateRange) {
                case '1-7': startDay = 1; endDay = 7; break;
                case '8-15': startDay = 8; endDay = 15; break;
                case '16-23': startDay = 16; endDay = 23; break;
                case '24-rest': startDay = 24; endDay = new Date(year, month + 1, 0).getDate(); break;
                default: return;
            }

            // Format dd/mm/yy
            const formatDate = (d) => {
                const dd = String(d).padStart(2, '0');
                const mm = String(month + 1).padStart(2, '0');
                const yy = String(year).slice(-2);
                return `${dd}/${mm}/${yy}`;
            };

            document.querySelector('.dated_bill').textContent = `${formatDate(startDay)} - ${formatDate(endDay)}`;
        }

        function setDefaultDateRange() {
            const today = new Date();
            const currentDay = today.getDate();

            let selectedRange = '';
            if (currentDay >= 1 && currentDay <= 7) selectedRange = '1-7';
            else if (currentDay >= 8 && currentDay <= 15) selectedRange = '8-15';
            else if (currentDay >= 16 && currentDay <= 23) selectedRange = '16-23';
            else selectedRange = '24-rest';

            // Adjust for current date - 5
            const adjustedDate = new Date(today);
            adjustedDate.setDate(currentDay - 5);
            const adjustedDay = adjustedDate.getDate();

            if (adjustedDay >= 1 && adjustedDay <= 7) selectedRange = '1-7';
            else if (adjustedDay >= 8 && adjustedDay <= 15) selectedRange = '8-15';
            else if (adjustedDay >= 16 && adjustedDay <= 23) selectedRange = '16-23';
            else selectedRange = '24-rest';

            currentDateRange = selectedRange;
            updateDateRangeButtons();
            updateDatedBillDisplay(); // üëà update div when default set
        }

        function setupEventListeners() {
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    currentDateRange = this.dataset.range;
                    updateDateRangeButtons();
                    updateDatedBillDisplay(); // üëà update div when button clicked
                    loadData();
                });
            });
        }

        function updateDateRangeButtons() {
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.range === currentDateRange);
            });
        }

        function getDatesInRange(range) {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const dates = [];

            let startDay, endDay;

            switch (range) {
                case '1-7': startDay = 1; endDay = 7; break;
                case '8-15': startDay = 8; endDay = 15; break;
                case '16-23': startDay = 16; endDay = 23; break;
                case '24-rest': startDay = 24; endDay = new Date(year, month + 1, 0).getDate(); break;
                default: return dates;
            }

            for (let day = startDay; day <= endDay; day++) {
                const formattedDate = `${day}-${month + 1}-${year}`;
                dates.push(formattedDate);
            }

            return dates;
        }

        async function loadData() {
            try {
                // show small table placeholder (unchanged)
                showLoading();
                clearError();

                // show overlay loading screen (added)
                if (window.LoadingScreen) {
                    try {
                        window.LoadingScreen.createParticles();
                        window.LoadingScreen.show('Loading data', 'Fetching records...');
                        window.LoadingScreen.setProgress(5);
                    } catch (e) {
                        console.warn('LoadingScreen failed to show:', e);
                    }
                }

                const dates = getDatesInRange(currentDateRange);
                databaseData = {};
                allNames.clear();

                fixedNames.forEach(name => allNames.add(name));

                for (let i = 0; i < dates.length; i++) {
                    const date = dates[i];
                    try {
                        const snapshot = await get(child(dbRef, `records/${date}`));
                        if (snapshot.exists()) {
                            const dayData = snapshot.val();
                            Object.keys(dayData).forEach(nameKey => {
                                const personData = dayData[nameKey];
                                let actualName = nameKey;

                                Object.keys(personData).forEach(session => {
                                    if (personData[session] && personData[session].name) {
                                        actualName = personData[session].name;
                                    }
                                });

                                allNames.add(actualName);

                                if (!databaseData[actualName]) {
                                    databaseData[actualName] = { kg: 0, takaMain: 0 };
                                }

                                Object.keys(personData).forEach(session => {
                                    const sessionData = personData[session];
                                    if (sessionData && sessionData.kg && sessionData.total) {
                                        databaseData[actualName].kg += parseFloat(sessionData.kg) || 0;
                                        databaseData[actualName].takaMain += parseFloat(sessionData.total) || 0;
                                    }
                                });
                            });
                        }
                    } catch (error) {
                        console.warn(`Failed to load data for ${date}:`, error);
                    }

                    // update progress roughly based on dates processed
                    if (window.LoadingScreen) {
                        try {
                            const percent = Math.round(((i + 1) / dates.length) * 90); // up to 90% during fetch
                            window.LoadingScreen.setProgress(percent);
                        } catch (e) { /* ignore */ }
                    }
                }

                createNameCheckboxes();
                renderTable();

                // mark complete and hide overlay
                if (window.LoadingScreen) {
                    try {
                        window.LoadingScreen.setProgress(100);
                        // small delay so user sees 100%
                        setTimeout(() => {
                            try { window.LoadingScreen.hide(); } catch (e) { /* ignore */ }
                        }, 300);
                    } catch (e) {
                        console.warn('Failed to hide LoadingScreen:', e);
                    }
                }

            } catch (error) {
                showError('Failed to load data: ' + (error && error.message ? error.message : error));
                console.error('Error loading data:', error);

                // ensure overlay hidden on error
                if (window.LoadingScreen) {
                    try { window.LoadingScreen.hide(); } catch (e) { /* ignore */ }
                }
            }
        }

        function createNameCheckboxes() {
            const checkboxContainer = document.getElementById('nameCheckboxes');
            checkboxContainer.innerHTML = '';

            const sortedNames = Array.from(allNames).sort();
            const fixedNamesList = sortedNames.filter(name => fixedNames.includes(name));
            const otherNamesList = sortedNames.filter(name =>
                !fixedNames.includes(name) && !preselectedNames.includes(name)
            );

            let counter = 1;

            fixedNamesList.forEach(name => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'checkbox-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `checkbox_${name}`;
                checkbox.value = name;
                checkbox.checked = true;
                checkbox.addEventListener('change', renderTable);

                const label = document.createElement('label');
                label.htmlFor = `checkbox_${name}`;
                label.textContent = `${counter}. ${name}`;
                counter++;

                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                checkboxContainer.appendChild(checkboxDiv);
            });

            preselectedNames.forEach(name => {
                if (allNames.has(name)) {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'checkbox-item';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `checkbox_${name}`;
                    checkbox.value = name;
                    checkbox.checked = true;
                    checkbox.addEventListener('change', renderTable);

                    const label = document.createElement('label');
                    label.htmlFor = `checkbox_${name}`;
                    label.textContent = `${counter}. ${name}`;
                    counter++;

                    checkboxDiv.appendChild(checkbox);
                    checkboxDiv.appendChild(label);
                    checkboxContainer.appendChild(checkboxDiv);
                }
            });

            otherNamesList.forEach(name => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'checkbox-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `checkbox_${name}`;
                checkbox.value = name;
                checkbox.checked = false;
                checkbox.addEventListener('change', renderTable);

                const label = document.createElement('label');
                label.htmlFor = `checkbox_${name}`;
                label.textContent = `${counter}. ${name}`;
                counter++;

                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                checkboxContainer.appendChild(checkboxDiv);
            });
        }

        function getSelectedNames() {
            const checkboxes = document.querySelectorAll('#nameCheckboxes input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function showLoading() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '<tr class="loading"><td colspan="4">Loading data...</td></tr>';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `<div class="error">${message}</div>`;
        }

        function clearError() {
            document.getElementById('errorMessage').innerHTML = '';
        }

        function renderTable() {
            const tableBody = document.getElementById('tableBody');
            const selectedNames = getSelectedNames();
            tableBody.innerHTML = '';

            const billKg = parseFloat(document.getElementById('billKg').value) || 0;
            const billTotalRupee = parseFloat(document.getElementById('billTotalRupee').value) || 0;

            const databaseRows = [];
            let databasePeopleTotalKg = 0;
            let databasePeopleTotalTakaLess = 0;
            let databasePeopleTotalTakaMain = 0;

            selectedNames.forEach(name => {
                if (!fixedNames.includes(name)) {
                    const data = databaseData[name] || { kg: 0, takaMain: 0 };
                    const takaLessInt = Math.ceil((data.takaMain || 0) * conversionFactor_ToMake_original_Less);
                    databaseRows.push({ name, kg: data.kg || 0, takaMain: data.takaMain || 0, takaLess: takaLessInt });
                    databasePeopleTotalKg += data.kg || 0;
                    databasePeopleTotalTakaLess += takaLessInt;
                    databasePeopleTotalTakaMain += data.takaMain || 0;
                }
            });

            const remainingKg = billKg - databasePeopleTotalKg;
            let remainingTakaLess = Math.round(billTotalRupee - databasePeopleTotalTakaLess);

            const selectedFixed = fixedNames.filter(n => selectedNames.includes(n));
            const nFixed = selectedFixed.length;

            if (remainingTakaLess < 0) {
                remainingTakaLess = 0;
                showError('Warning: Please input the bill KG & TOTAL.');
            } else {
                clearError();
            }

            const fixedAlloc = {};
            if (nFixed > 0) {
                const baseShare = Math.floor(remainingTakaLess / nFixed);
                let remainder = remainingTakaLess % nFixed;
                selectedFixed.forEach(name => {
                    let share = baseShare + (remainder > 0 ? 1 : 0);
                    if (remainder > 0) remainder--;
                    fixedAlloc[name] = { takaLess: share, takaMain: share * conversionFactor_ToMake_original };
                });
            }

            let totalKg = 0, totalTakaLess = 0, totalTakaMain = 0;
            const fixedKgEach = nFixed > 0 ? (remainingKg / nFixed) : 0;

            selectedFixed.forEach(name => {
                const alloc = fixedAlloc[name] || { takaLess: 0, takaMain: 0 };
                const row = createTableRow(name, fixedKgEach, alloc.takaMain, true, alloc.takaLess);
                tableBody.appendChild(row);
                totalKg += fixedKgEach;
                totalTakaLess += alloc.takaLess;
                totalTakaMain += alloc.takaMain;
            });

            databaseRows.forEach(item => {
                const row = createTableRow(item.name, item.kg, item.takaMain, false, item.takaLess);
                tableBody.appendChild(row);
                totalKg += item.kg;
                totalTakaLess += item.takaLess;
                totalTakaMain += item.takaMain;
            });

            document.getElementById('totalKg').textContent = totalKg.toFixed(1);
            document.getElementById('totalTakaLess').textContent = Number(totalTakaLess).toFixed(0);
            document.getElementById('totalTakaMain').textContent = totalTakaMain.toFixed(0);
        }

        function createTableRow(name, kg, takaMain, isFixed, providedTakaLess = null) {
            const row = document.createElement('tr');
            row.className = isFixed ? 'fixed-row' : 'database-row';
            const takaLess = (providedTakaLess !== null)
                ? providedTakaLess
                : Math.ceil((takaMain || 0) * conversionFactor_ToMake_original_Less);

            row.innerHTML = `
            <td>${name}</td>
            <td class="numeric">${(kg || 0).toFixed(1)}</td>
            <td class="numeric">${Number(takaLess).toFixed(0)}</td>
            <td class="numeric">${(takaMain || 0).toFixed(0)}</td>
        `;
            return row;
        }

        // Download screenshot function
        window.downloadTableScreenshot = async function () {
            const downloadBtn = document.getElementById('downloadBtn');
            const tableContainer = document.getElementById('tableContainer');

            // Disable button and show loading state
            downloadBtn.disabled = true;
            downloadBtn.textContent = 'üì∏ Capturing Screenshot...';

            try {
                // Configure html2canvas options for better quality
                const canvas = await html2canvas(tableContainer, {
                    backgroundColor: '#ffffff',
                    scale: 2, // Higher resolution
                    useCORS: true,
                    allowTaint: true,
                    height: tableContainer.scrollHeight,
                    width: tableContainer.scrollWidth,
                    scrollX: 0,
                    scrollY: 0
                });

                // Convert canvas to blob
                canvas.toBlob(function (blob) {
                    // Create download link
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');

                    // Get current date for filename
                    const now = new Date();
                    const dateStr = now.toISOString().split('T')[0]; // YYYY-MM-DD format
                    const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-'); // HH-MM-SS format

                    link.href = url;
                    link.download = `Bill_Table_${dateStr}_${timeStr}.jpg`;

                    // Trigger download
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    // Clean up
                    URL.revokeObjectURL(url);

                    // Reset button
                    downloadBtn.disabled = false;
                    downloadBtn.textContent = 'üì∑ Download Table Screenshot';

                }, 'image/jpeg', 0.95); // High quality JPEG

            } catch (error) {
                console.error('Error capturing screenshot:', error);
                alert('Failed to capture screenshot. Please try again.');

                // Reset button
                downloadBtn.disabled = false;
                downloadBtn.textContent = 'üì∑ Download Table Screenshot';
            }
        };

        window.loadData = loadData;
        window.updateTable = function () { renderTable(); };
    </script>
</body>

</html>