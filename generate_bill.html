<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Page</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-top: 0;
            margin-bottom: 10px;
        }

        .date-range-selector {
            margin-bottom: 20px;
            text-align: center;
        }

        .date-range-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .date-btn {
            padding: 10px 15px;
            border: 2px solid #007bff;
            background: white;
            color: #007bff;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .date-btn.active {
            background: #007bff;
            color: white;
        }

        .date-btn:hover {
            background: #0056b3;
            color: white;
        }

        .checkbox-section {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        .billbox-section {
            margin: 20px 0;
            padding: 10px;
            max-width: 600px;
            background: #d8ecff;
            border-radius: 5px;
            margin-bottom: 60px;
        }


        .checkbox-section h3 {
            margin-top: 0;
            color: #333;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            font-size: 1rem;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            transform: scale(1.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
        }

        th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            text-align: right;

        }

        .fixed-row {
            background-color: #f9f9f9;
            font-weight: bold;
        }

        .database-row {
            background-color: #f9f9f9;
        }

        .database-row:nth-child(even) {
            background-color: #ffffff;
        }

        .footer-row {
            background-color: #28a745;
            color: white;
            font-weight: bold;
        }

        .numeric {
            text-align: right;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            color: #dc3545;
            text-align: center;
            padding: 14px;
            font-size: 0.9rem;
            background: #f8d7da;
            border-radius: 5px;
            margin: 5px 0;
        }

        .refresh-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }

        .refresh-btn:hover {
            background: #218838;
        }

        th:first-child,
        td:first-child {
            text-align: left;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {

            .checkbox-section {
                padding: 10px;
            }

            .checkbox-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 5px;
            }

            .checkbox-item {
                font-size: 0.85rem;
            }

            table {
                width: 100%;
                max-width: 600px;
                border-collapse: collapse;
                margin-top: 0;
            }

            th,
            td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }

            th {
                background-color: #007bff;
                color: white;
                padding: 4px;
                font-size: 13px;
                text-align: center;
                font-weight: bold;
            }

            /* First column min 100px */
            th:first-child,
            td:first-child {
                min-width: 100px;
                text-align: left;
            }

        }

        .dated_bill {
            display: inline-block;
            padding: 6px 14px;
            background: #f0f8ff;
            /* soft blue background */
            color: #222;
            /* dark text */
            font-weight: 700;
            margin-bottom: 5px;
            font-size: 17px;
            border: 2px solid #007bff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            letter-spacing: 0.5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Bill Auto Genarated</h1>

        <div class="date-range-selector">
            <div class="date-range-buttons">
                <button class="date-btn" data-range="1-7">1-7</button>
                <button class="date-btn" data-range="8-15">8-15</button>
                <button class="date-btn" data-range="16-23">16-23</button>
                <button class="date-btn" data-range="24-rest">24-Rest</button>
            </div>
        </div>

        <div class="checkbox-section">
            <h3>Select Names</h3>
            <div class="checkbox-grid" id="nameCheckboxes">
                <!-- Checkboxes will be populated here -->
            </div>
            <button class="refresh-btn" onclick="loadData()">Refresh Data</button>
        </div>

    </div>
    <div class="billbox-section">
        <div id="errorMessage"></div>


        <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
            <div>
                <label for="billKg" style="margin-right: 4px;">মোট দুধ :</label>
                <input type="number" id="billKg" step="0.01" min="0" value="" onchange="updateTable() "
                    placeholder="0 kg" oninput="updateTable()"
                    style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 70px;font-size: 1.2rem;">
            </div>
            <div>
                <label for="billTotalRupee" style="margin-right:4px;">মোট টাকা :</label>
                <input type="number" id="billTotalRupee" step="0.01" min="0" value="" onchange="updateTable()"
                    placeholder="₹ 0" oninput="updateTable()"
                    style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 70px;font-size: 1.2rem;">
            </div>
        </div>

        <div class="dated_bill">
            <!-- Date range will appear here -->
        </div>
        <table id="billTable">
            <thead>
                <tr>
                    <th>নাম</th>
                    <th>পরিমাণ (Kg)</th>
                    <th>29 টাকা</th>
                    <th>40.5 টাকা</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                <tr class="loading">
                    <td colspan="4">Loading data...</td>
                </tr>
            </tbody>
            <tfoot>
                <tr class="footer-row">
                    <td><strong>Total</strong></td>
                    <td class="numeric" id="totalKg">0.00</td>
                    <td class="numeric" id="totalTakaLess">0.00</td>
                    <td class="numeric" id="totalTakaMain">0.00</td>
                </tr>
            </tfoot>
        </table>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAuhNKygw6dv8jqfNY8qnmIrX-TsLy2jvI",
            authDomain: "dairy-app-abhijit.firebaseapp.com",
            databaseURL: "https://dairy-app-abhijit-default-rtdb.firebaseio.com",
            projectId: "dairy-app-abhijit",
            storageBucket: "dairy-app-abhijit.appspot.com",
            messagingSenderId: "196152880143",
            appId: "1:196152880143:web:bec02170e30932a7d5877a"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase();
        const dbRef = ref(database);

        let currentDateRange = '';
        let allNames = new Set();
        let databaseData = {};

        // Conversion factors
        const conversionFactor_ToMake_original = 40.50 / 29;
        const conversionFactor_ToMake_original_Less = 29 / 40.5;

        // Fixed names always appear first
        const fixedNames = ['Name1', 'Name2'];

        // Pre-selected names
        const preselectedNames = [
            'মধুমিতা মন্ডল',
            'রজিনা শেখ',
            'বিজলা দুলে',
            'সুদর্শন ঘোষ',
            'মমতা ঘোষ',
            'ঝর্না চচ্চড়ি',
            'সুলোচনা ঘোষ',
            'বুল্টি দুলে'
        ];

        // Initialize the page
        window.onload = function () {
            setDefaultDateRange();
            setupEventListeners();
            loadData();
        };

        // --- New: Show formatted range in .dated_bill ---
        function updateDatedBillDisplay() {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth(); // 0-based
            let startDay, endDay;

            switch (currentDateRange) {
                case '1-7':
                    startDay = 1;
                    endDay = 7;
                    break;
                case '8-15':
                    startDay = 8;
                    endDay = 15;
                    break;
                case '16-23':
                    startDay = 16;
                    endDay = 23;
                    break;
                case '24-rest':
                    startDay = 24;
                    endDay = new Date(year, month + 1, 0).getDate(); // last day of month
                    break;
                default:
                    return;
            }

            // Format dd/mm/yy
            const formatDate = (d) => {
                const dd = String(d).padStart(2, '0');
                const mm = String(month + 1).padStart(2, '0');
                const yy = String(year).slice(-2);
                return `${dd}/${mm}/${yy}`;
            };

            document.querySelector('.dated_bill').textContent =
                `${formatDate(startDay)} - ${formatDate(endDay)}`;
        }

        function setDefaultDateRange() {
            const today = new Date();
            const currentDay = today.getDate();

            let selectedRange = '';
            if (currentDay >= 1 && currentDay <= 7) {
                selectedRange = '1-7';
            } else if (currentDay >= 8 && currentDay <= 15) {
                selectedRange = '8-15';
            } else if (currentDay >= 16 && currentDay <= 23) {
                selectedRange = '16-23';
            } else {
                selectedRange = '24-rest';
            }

            // Adjust for current date - 5
            const adjustedDate = new Date(today);
            adjustedDate.setDate(currentDay - 5);
            const adjustedDay = adjustedDate.getDate();

            if (adjustedDay >= 1 && adjustedDay <= 7) {
                selectedRange = '1-7';
            } else if (adjustedDay >= 8 && adjustedDay <= 15) {
                selectedRange = '8-15';
            } else if (adjustedDay >= 16 && adjustedDay <= 23) {
                selectedRange = '16-23';
            } else {
                selectedRange = '24-rest';
            }

            currentDateRange = selectedRange;
            updateDateRangeButtons();
            updateDatedBillDisplay(); // 👈 update div when default set
        }

        function setupEventListeners() {
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    currentDateRange = this.dataset.range;
                    updateDateRangeButtons();
                    updateDatedBillDisplay(); // 👈 update div when button clicked
                    loadData();
                });
            });
        }

        function updateDateRangeButtons() {
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.range === currentDateRange);
            });
        }

        function getDatesInRange(range) {
            const today = new Date();
            const year = today.getFullYear();
            const month = today.getMonth();
            const dates = [];

            let startDay, endDay;

            switch (range) {
                case '1-7':
                    startDay = 1;
                    endDay = 7;
                    break;
                case '8-15':
                    startDay = 8;
                    endDay = 15;
                    break;
                case '16-23':
                    startDay = 16;
                    endDay = 23;
                    break;
                case '24-rest':
                    startDay = 24;
                    endDay = new Date(year, month + 1, 0).getDate();
                    break;
                default:
                    return dates;
            }

            for (let day = startDay; day <= endDay; day++) {
                const formattedDate = `${day}-${month + 1}-${year}`;
                dates.push(formattedDate);
            }

            return dates;
        }

        async function loadData() {
            try {
                showLoading();
                clearError();

                const dates = getDatesInRange(currentDateRange);
                databaseData = {};
                allNames.clear();

                fixedNames.forEach(name => allNames.add(name));

                for (const date of dates) {
                    try {
                        const snapshot = await get(child(dbRef, `records/${date}`));
                        if (snapshot.exists()) {
                            const dayData = snapshot.val();
                            Object.keys(dayData).forEach(nameKey => {
                                const personData = dayData[nameKey];
                                let actualName = nameKey;

                                Object.keys(personData).forEach(session => {
                                    if (personData[session] && personData[session].name) {
                                        actualName = personData[session].name;
                                    }
                                });

                                allNames.add(actualName);

                                if (!databaseData[actualName]) {
                                    databaseData[actualName] = { kg: 0, takaMain: 0 };
                                }

                                Object.keys(personData).forEach(session => {
                                    const sessionData = personData[session];
                                    if (sessionData && sessionData.kg && sessionData.total) {
                                        databaseData[actualName].kg += parseFloat(sessionData.kg) || 0;
                                        databaseData[actualName].takaMain += parseFloat(sessionData.total) || 0;
                                    }
                                });
                            });
                        }
                    } catch (error) {
                        console.warn(`Failed to load data for ${date}:`, error);
                    }
                }

                createNameCheckboxes();
                renderTable();

            } catch (error) {
                showError('Failed to load data: ' + error.message);
                console.error('Error loading data:', error);
            }
        }

        function createNameCheckboxes() {
            const checkboxContainer = document.getElementById('nameCheckboxes');
            checkboxContainer.innerHTML = '';

            const sortedNames = Array.from(allNames).sort();
            const fixedNamesList = sortedNames.filter(name => fixedNames.includes(name));
            const otherNamesList = sortedNames.filter(name =>
                !fixedNames.includes(name) && !preselectedNames.includes(name)
            );

            let counter = 1;

            fixedNamesList.forEach(name => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'checkbox-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `checkbox_${name}`;
                checkbox.value = name;
                checkbox.checked = true;
                checkbox.addEventListener('change', renderTable);

                const label = document.createElement('label');
                label.htmlFor = `checkbox_${name}`;
                label.textContent = `${counter}. ${name}`;
                counter++;

                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                checkboxContainer.appendChild(checkboxDiv);
            });

            preselectedNames.forEach(name => {
                if (allNames.has(name)) {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'checkbox-item';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `checkbox_${name}`;
                    checkbox.value = name;
                    checkbox.checked = true;
                    checkbox.addEventListener('change', renderTable);

                    const label = document.createElement('label');
                    label.htmlFor = `checkbox_${name}`;
                    label.textContent = `${counter}. ${name}`;
                    counter++;

                    checkboxDiv.appendChild(checkbox);
                    checkboxDiv.appendChild(label);
                    checkboxContainer.appendChild(checkboxDiv);
                }
            });

            otherNamesList.forEach(name => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'checkbox-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `checkbox_${name}`;
                checkbox.value = name;
                checkbox.checked = false;
                checkbox.addEventListener('change', renderTable);

                const label = document.createElement('label');
                label.htmlFor = `checkbox_${name}`;
                label.textContent = `${counter}. ${name}`;
                counter++;

                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                checkboxContainer.appendChild(checkboxDiv);
            });
        }

        function getSelectedNames() {
            const checkboxes = document.querySelectorAll('#nameCheckboxes input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        function showLoading() {
            const tableBody = document.getElementById('tableBody');
            tableBody.innerHTML = '<tr class="loading"><td colspan="4">Loading data...</td></tr>';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.innerHTML = `<div class="error">${message}</div>`;
        }

        function clearError() {
            document.getElementById('errorMessage').innerHTML = '';
        }

        function renderTable() {
            const tableBody = document.getElementById('tableBody');
            const selectedNames = getSelectedNames();
            tableBody.innerHTML = '';

            const billKg = parseFloat(document.getElementById('billKg').value) || 0;
            const billTotalRupee = parseFloat(document.getElementById('billTotalRupee').value) || 0;

            const databaseRows = [];
            let databasePeopleTotalKg = 0;
            let databasePeopleTotalTakaLess = 0;
            let databasePeopleTotalTakaMain = 0;

            selectedNames.forEach(name => {
                if (!fixedNames.includes(name)) {
                    const data = databaseData[name] || { kg: 0, takaMain: 0 };
                    const takaLessInt = Math.ceil((data.takaMain || 0) * conversionFactor_ToMake_original_Less);
                    databaseRows.push({ name, kg: data.kg || 0, takaMain: data.takaMain || 0, takaLess: takaLessInt });
                    databasePeopleTotalKg += data.kg || 0;
                    databasePeopleTotalTakaLess += takaLessInt;
                    databasePeopleTotalTakaMain += data.takaMain || 0;
                }
            });

            const remainingKg = billKg - databasePeopleTotalKg;
            let remainingTakaLess = Math.round(billTotalRupee - databasePeopleTotalTakaLess);

            const selectedFixed = fixedNames.filter(n => selectedNames.includes(n));
            const nFixed = selectedFixed.length;

            if (remainingTakaLess < 0) {
                remainingTakaLess = 0;
                showError('Warning: Please input the bill KG & TOTAL.');
            } else {
                clearError();
            }

            const fixedAlloc = {};
            if (nFixed > 0) {
                const baseShare = Math.floor(remainingTakaLess / nFixed);
                let remainder = remainingTakaLess % nFixed;
                selectedFixed.forEach(name => {
                    let share = baseShare + (remainder > 0 ? 1 : 0);
                    if (remainder > 0) remainder--;
                    fixedAlloc[name] = { takaLess: share, takaMain: share * conversionFactor_ToMake_original };
                });
            }

            let totalKg = 0, totalTakaLess = 0, totalTakaMain = 0;
            const fixedKgEach = nFixed > 0 ? (remainingKg / nFixed) : 0;

            selectedFixed.forEach(name => {
                const alloc = fixedAlloc[name] || { takaLess: 0, takaMain: 0 };
                const row = createTableRow(name, fixedKgEach, alloc.takaMain, true, alloc.takaLess);
                tableBody.appendChild(row);
                totalKg += fixedKgEach;
                totalTakaLess += alloc.takaLess;
                totalTakaMain += alloc.takaMain;
            });

            databaseRows.forEach(item => {
                const row = createTableRow(item.name, item.kg, item.takaMain, false, item.takaLess);
                tableBody.appendChild(row);
                totalKg += item.kg;
                totalTakaLess += item.takaLess;
                totalTakaMain += item.takaMain;
            });

            document.getElementById('totalKg').textContent = totalKg.toFixed(1);
            document.getElementById('totalTakaLess').textContent = Number(totalTakaLess).toFixed(0);
            document.getElementById('totalTakaMain').textContent = totalTakaMain.toFixed(0);
        }

        function createTableRow(name, kg, takaMain, isFixed, providedTakaLess = null) {
            const row = document.createElement('tr');
            row.className = isFixed ? 'fixed-row' : 'database-row';
            const takaLess = (providedTakaLess !== null)
                ? providedTakaLess
                : Math.ceil((takaMain || 0) * conversionFactor_ToMake_original_Less);

            row.innerHTML = `
            <td>${name}</td>
            <td class="numeric">${(kg || 0).toFixed(1)}</td>
            <td class="numeric">${Number(takaLess).toFixed(0)}</td>
            <td class="numeric">${(takaMain || 0).toFixed(0)}</td>
        `;
            return row;
        }

        window.loadData = loadData;
        window.updateTable = function () {
            renderTable();
        };
    </script>
</body>

</html>