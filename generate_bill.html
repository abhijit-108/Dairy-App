<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Bill Auto Genarated</title>

    <!-- === Loading screen CSS (extracted & self-contained) === -->
    <style>
        :root {
            --bg-a: #020a2b;
            --bg-b: #764ba2;
            --bg-c: #f093fb;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        /* --- enhanced loading screen styles (keeps original look but adds percent + ticks) --- */
        #loadingScreen {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--bg-a) 0%, var(--bg-b) 50%, var(--bg-c) 100%);
            background-size: 400% 400%;
            animation: gradientShift 6s ease infinite;
            z-index: 99999;
            transition: opacity .8s ease-out, visibility .8s ease-out;
            overflow: hidden;
        }

        #loadingScreen.fade-out {
            opacity: 0;
            visibility: hidden;
        }

        @keyframes gradientShift {
            0% {
                background-position: 0% 50%
            }

            50% {
                background-position: 100% 50%
            }

            100% {
                background-position: 0% 50%
            }
        }

        .particles {
            position: absolute;
            inset: 0;
            pointer-events: none;
            z-index: 1;
            overflow: hidden;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, .6);
            border-radius: 50%;
            animation: float 8s infinite linear;
        }

        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0
            }

            10% {
                opacity: 1
            }

            90% {
                opacity: 1
            }

            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0
            }
        }

        /* loading container (kept look but slightly tighter to accommodate percent) */
        .loading-container {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 22px 28px;
            background: rgba(255, 255, 255, .08);
            backdrop-filter: blur(18px);
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, .16);
            box-shadow: 0 20px 40px rgba(0, 0, 0, .12);
            animation: containerPulse 2s ease-in-out infinite alternate;
            max-width: 420px;
            width: calc(100% - 40px);
        }

        @keyframes containerPulse {
            0% {
                transform: scale(1) translateY(0)
            }

            100% {
                transform: scale(1.02) translateY(-5px)
            }
        }

        .loading-spinner {
            width: 72px;
            height: 72px;
            position: relative;
            margin-bottom: 12px;
        }

        .spinner-ring {
            position: absolute;
            border: 3px solid transparent;
            border-radius: 50%;
            animation: spin 2s linear infinite;
        }

        .spinner-ring:nth-child(1) {
            width: 72px;
            height: 72px;
            border-top: 3px solid #fff;
            border-right: 3px solid #fff;
            animation-duration: 2s;
        }

        .spinner-ring:nth-child(2) {
            width: 52px;
            height: 52px;
            top: 10px;
            left: 10px;
            border-bottom: 3px solid rgba(255, 255, 255, .85);
            border-left: 3px solid rgba(255, 255, 255, .85);
            animation-duration: 1.5s;
            animation-direction: reverse;
        }

        .spinner-ring:nth-child(3) {
            width: 32px;
            height: 32px;
            top: 20px;
            left: 20px;
            border-top: 3px solid rgba(255, 255, 255, .6);
            border-right: 3px solid rgba(255, 255, 255, .6);
            animation-duration: 1s;
        }

        @keyframes spin {
            0% {
                transform: rotate(0)
            }

            100% {
                transform: rotate(360deg)
            }
        }

        /* header with text + percent */
        .loading-header {
            display: flex;
            align-items: baseline;
            gap: 12px;
            margin-bottom: 6px;
            width: 100%;
            justify-content: center;
        }

        .loading-text {
            color: #fff;
            font-size: 20px;
            font-weight: 700;
            text-align: center;
            margin: 0;
            text-shadow: 0 2px 8px rgba(0, 0, 0, .25);
            letter-spacing: .6px;
        }

        .loading-percent {
            color: rgba(255, 255, 255, 0.95);
            font-size: 18px;
            font-weight: 800;
            min-width: 60px;
            text-align: center;
            background: rgba(0, 0, 0, 0.12);
            padding: 6px 10px;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.25);
        }

        .loading-subtext {
            color: rgba(255, 255, 255, .95);
            font-size: 14px;
            text-align: center;
            font-weight: 400;
            text-shadow: 0 1px 4px rgba(0, 0, 0, .18);
            margin-top: 8px;
        }

        .progress-container {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, .14);
            border-radius: 8px;
            margin-top: 12px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #fff, rgba(255, 255, 255, .85));
            border-radius: 8px;
            width: 0%;
            transition: width .4s ease;
        }

        /* legend ticks 10..100 */
        .progress-legend {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            gap: 6px;
            width: 100%;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.95);
            user-select: none;
        }

        .progress-legend .tick {
            opacity: 0.45;
            transition: opacity .25s ease, transform .18s ease, color .18s ease;
            padding: 2px 6px;
            border-radius: 6px;
            transform-origin: center;
        }

        .progress-legend .tick.active {
            opacity: 1;
            transform: translateY(-4px) scale(1.05);
            background: rgba(255, 255, 255, 0.06);
            color: #fff;
        }

        @media (max-width:600px) {
            .loading-container {
                padding: 18px
            }

            .loading-text {
                font-size: 18px
            }

            .progress-container {
                width: 100%
            }

            .loading-percent {
                font-size: 16px;
                min-width: 48px;
            }

            .progress-legend {
                font-size: 10px;
            }
        }

        @media (prefers-color-scheme:dark) {
            #loadingScreen {
                background: linear-gradient(135deg, #080b2a 0%, #210a37 50%, #512da8 100%);
            }
        }
    </style>

    <!-- === Your original page CSS (unchanged) === -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-top: 0;
            margin-bottom: 10px;
        }

        .date-range-selector {
            margin-bottom: 20px;
            text-align: center;
        }

        .date-range-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .date-btn {
            padding: 6px 10px;
            border: 2px solid #007bff;
            background: white;
            color: #007bff;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .date-btn.active {
            background: #007bff;
            color: white;
        }

        .date-btn:hover {
            background: #0056b3;
            color: white;
        }

        .checkbox-section {
            margin: 20px 0;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 5px;
        }

        .billbox-section {
            margin: 0;
            padding: 10px;
            margin-left: auto;
            margin-right: auto;
            max-width: 600px;
            background: #d8ecff;
            border-radius: 5px;
            margin-bottom: 60px;
        }

        .checkbox-section h3 {
            margin-top: 0;
            color: #333;
        }

        .checkbox-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            font-size: 1rem;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            transform: scale(1.2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 6px;
            text-align: left;
        }

        th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
            text-align: right;
        }

        .fixed-row {
            background-color: #f9f9f9;
            font-weight: bold;
        }

        .database-row {
            background-color: #f9f9f9;
        }

        .database-row:nth-child(even) {
            background-color: #ffffff;
        }

        .footer-row {
            background-color: #28a745;
            color: white;
            font-weight: bold;
        }

        .numeric {
            text-align: right;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }

        .error {
            color: #dc3545;
            text-align: center;
            padding: 12px;
            width: max-content;
            font-size: 0.8rem;
            background: #f8d7da;
            border-radius: 5px;
            margin: 10px 0;
        }

        .refresh-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 5px;
            cursor: pointer;
            margin: 10px;
        }

        .refresh-btn:hover {
            background: #218838;
        }

        .download-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 5px;
            cursor: pointer;
            margin: 15px auto;
            display: block;
            font-size: 16px;
            font-weight: bold;
            transition: background 0.3s;
        }

        .download-btn:hover {
            background: #138496;
        }

        .download-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }

        th:first-child,
        td:first-child {
            text-align: left;
        }

        @media (max-width: 768px) {
            .checkbox-section {
                padding: 10px;
            }

            h1 {
                font-size: 1.3rem;
                font-weight: bolder;
            }

            .checkbox-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
                gap: 5px;
            }

            .checkbox-item {
                font-size: 0.85rem;
            }

            table {
                width: 100%;
                max-width: 600px;
                border-collapse: collapse;
                margin-top: 0;
            }

            th,
            td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }

            th {
                background-color: #007bff;
                color: white;
                padding: 4px;
                font-size: 12px;
                text-align: center;
                font-weight: bold;
            }

            th:first-child {
                text-align: center;
            }

            td:first-child {
                min-width: 100px;
                text-align: left;
            }
        }

        .dated_bill {
            display: inline-block;
            padding: 6px 14px;
            background: #f0f8ff;
            color: #222;
            font-weight: 700;
            margin-bottom: 5px;
            font-size: 17px;
            border: 2px solid #007bff;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.08);
            letter-spacing: 0.5px;
        }

        #tableContainer {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        @media (prefers-color-scheme: dark) {
            body {
                background-color: #1a1a1a;
                color: #e0e0e0;
            }

            .container {
                background: #2d2d2d;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            }

            h1 {
                color: #e0e0e0;
            }

            .checkbox-section {
                background: #3d3d3d;
            }

            .checkbox-section h3 {
                color: #e0e0e0;
            }

            .billbox-section {
                background: #2c3e50;
                margin: 0;
                padding: 5px;
            }

            table {
                color: #e0e0e0;
            }

            th,
            td {
                border-color: #555;
            }

            .fixed-row {
                background-color: #3d3d3d;
            }

            .database-row {
                background-color: #3d3e3d;
            }

            .database-row:nth-child(even) {
                background-color: #2d2d2d;
            }

            #tableContainer {
                background: #2d2d2d;
                padding: 8px;
            }

            .dated_bill {
                background: #2c3e50;
                color: #e0e0e0;
                border-color: #3498db;
            }
        }

        .responsive-pair {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-start;
        }

        .panel {
            flex: 1 1 320px;
            min-width: 260px;
            padding: 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            box-sizing: border-box;
        }

        .fixed-left .panel-left {
            flex: 0 0 300px;
            min-width: 200px;
        }

        .fixed-left .panel-right {
            flex: 1 1 0;
            min-width: 200px;
        }

        .responsive-pair,
        .panel {
            max-width: 100%;
        }
    </style>
</head>

<body>

    <!-- Loading screen markup (self-contained) -->
    <div id="loadingScreen" role="status" aria-live="polite" aria-label="Loading content" style="display:flex">
        <div class="particles" id="particles" aria-hidden="true"></div>

        <div class="loading-container" id="loadingContainer" aria-hidden="false">
            <div class="loading-spinner" aria-hidden="true">
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
                <div class="spinner-ring"></div>
            </div>

            <div class="loading-header">
                <div class="loading-text" id="loadingText">Loading</div>
                <div class="loading-percent" id="loadingPercent">0%</div>
            </div>

            <div class="loading-subtext" id="loadingSubtext">Please wait</div>

            <div class="progress-container" aria-hidden="true">
                <div class="progress-bar" id="progressBar" role="progressbar" aria-valuemin="0" aria-valuemax="100"
                    aria-valuenow="0"></div>
            </div>

            <div class="progress-legend" id="progressLegend" aria-hidden="true">
                <!-- ticks will be inserted by JS -->
            </div>
        </div>
    </div>

    <!-- === Page content (unchanged) === -->
    <div class="responsive-pair">
        <div class="panel panel-left">
            <div class="container">
                <h1>Bill Auto Genarated</h1>

                <div class="date-range-selector">
                    <div class="date-range-buttons">
                        <button class="date-btn" data-range="1-7">1-7</button>
                        <button class="date-btn" data-range="8-15">8-15</button>
                        <button class="date-btn" data-range="16-23">16-23</button>
                        <button class="date-btn" data-range="24-rest">24-Rest</button>
                    </div>
                </div>

                <div class="checkbox-section">
                    <h3>Select Names</h3>
                    <div class="checkbox-grid" id="nameCheckboxes">
                        <!-- Checkboxes will be populated here -->
                    </div>
                    <button class="refresh-btn" onclick="loadData()">Refresh Data</button>
                </div>

            </div>
        </div>

        <div class="panel panel-right">

            <div class="billbox-section">
                <div id="errorMessage"></div>

                <div style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
                    <div>
                        <label for="billKg" style="margin-right: 4px;">‡¶Æ‡ßã‡¶ü ‡¶¶‡ßÅ‡¶ß :</label>
                        <input type="number" id="billKg" step="0.01" min="0" value="" onchange="updateTable() "
                            placeholder="0 kg" oninput="updateTable()"
                            style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 70px;font-size: 1.2rem;">
                    </div>
                    <div>
                        <label for="billTotalRupee" style="margin-right:4px;">‡¶Æ‡ßã‡¶ü ‡¶ü‡¶æ‡¶ï‡¶æ :</label>
                        <input type="number" id="billTotalRupee" step="0.01" min="0" value="" onchange="updateTable()"
                            placeholder="‚Çπ 0" oninput="updateTable()"
                            style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; width: 70px;font-size: 1.2rem;">
                    </div>
                </div>

                <div id="tableContainer">
                    <div class="dated_bill">
                        <!-- Date range will appear here -->
                    </div>
                    <table id="billTable">
                        <thead>
                            <tr>
                                <th>‡¶®‡¶æ‡¶Æ</th>
                                <th>‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£ (Kg)</th>
                                <th>29 ‡¶ü‡¶æ‡¶ï‡¶æ</th>
                                <th>41.10 ‡¶ü‡¶æ‡¶ï‡¶æ</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr class="loading">
                                <td colspan="4">Loading data...</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="footer-row">
                                <td><strong>Total</strong></td>
                                <td class="numeric" id="totalKg">0.00</td>
                                <td class="numeric" id="totalTakaLess">0.00</td>
                                <td class="numeric" id="totalTakaMain">0.00</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <button class="download-btn" onclick="downloadTableScreenshot()" id="downloadBtn">
                    üì∑ Download Table Screenshot
                </button>
            </div>
        </div>
    </div>

    <!-- Add html2canvas library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- === Loading screen JS (self-contained, enhanced) === -->
    <script>
        (function () {
            const particlesEl = document.getElementById('particles');
            const loadingScreen = document.getElementById('loadingScreen');
            const loadingTextEl = document.getElementById('loadingText');
            const loadingSubtextEl = document.getElementById('loadingSubtext');
            const progressBarEl = document.getElementById('progressBar');
            const loadingPercentEl = document.getElementById('loadingPercent');
            const progressLegendEl = document.getElementById('progressLegend');

            function createParticles(count = 30) {
                if (!particlesEl) return;
                particlesEl.innerHTML = '';
                for (let i = 0; i < count; i++) {
                    const p = document.createElement('div');
                    p.className = 'particle';
                    p.style.left = Math.random() * 100 + '%';
                    p.style.animationDelay = (Math.random() * 6) + 's';
                    p.style.animationDuration = (Math.random() * 3 + 5) + 's';
                    p.style.opacity = (Math.random() * 0.6 + 0.2).toFixed(2);
                    particlesEl.appendChild(p);
                }
            }

            // build legend ticks 10..100
            function createLegend() {
                if (!progressLegendEl) return;
                progressLegendEl.innerHTML = '';
                for (let i = 10; i <= 100; i += 10) {
                    const tick = document.createElement('div');
                    tick.className = 'tick';
                    tick.dataset.percent = String(i);
                    tick.textContent = i + '%';
                    progressLegendEl.appendChild(tick);
                }
            }

            function showLoadingScreen(text = 'Loading', subtext = 'Please wait') {
                if (loadingTextEl) loadingTextEl.textContent = text;
                if (loadingSubtextEl) loadingSubtextEl.textContent = subtext;
                if (progressBarEl) {
                    progressBarEl.style.width = '0%';
                    progressBarEl.setAttribute('aria-valuenow', '0');
                }
                if (loadingPercentEl) loadingPercentEl.textContent = '0%';
                // reset ticks
                const ticks = progressLegendEl?.querySelectorAll('.tick') || [];
                ticks.forEach(t => t.classList.remove('active'));

                loadingScreen.classList.remove('fade-out');
                loadingScreen.style.display = 'flex';
            }

            function hideLoadingScreen() {
                loadingScreen.classList.add('fade-out');
                // remove DOM node after fade to avoid blocking interactions
                setTimeout(() => {
                    if (loadingScreen && loadingScreen.classList.contains('fade-out')) {
                        loadingScreen.style.display = 'none';
                    }
                }, 800);
            }

            function setProgress(percent) {
                const val = Math.max(0, Math.min(100, Math.round(Number(percent) || 0)));
                if (progressBarEl) {
                    progressBarEl.style.width = val + '%';
                    progressBarEl.setAttribute('aria-valuenow', String(val));
                }
                if (loadingPercentEl) loadingPercentEl.textContent = val + '%';

                // update subtext for nicer UX at specific points (optional)
                if (loadingSubtextEl) {
                    if (val < 10) loadingSubtextEl.textContent = 'Initializing...';
                    else if (val < 40) loadingSubtextEl.textContent = 'Fetching records...';
                    else if (val < 70) loadingSubtextEl.textContent = 'Processing data...';
                    else if (val < 100) loadingSubtextEl.textContent = 'Finalizing...';
                    else loadingSubtextEl.textContent = 'Done';
                }

                // Highlight ticks <= current 10%-step
                const step = Math.floor(val / 10) * 10;
                const ticks = progressLegendEl?.querySelectorAll('.tick') || [];
                ticks.forEach(t => {
                    const p = parseInt(t.dataset.percent, 10);
                    if (p <= step) t.classList.add('active');
                    else t.classList.remove('active');
                });
            }

            window.LoadingScreen = {
                createParticles,
                createLegend,
                show: showLoadingScreen,
                hide: hideLoadingScreen,
                setProgress
            };

            // init particles and legend so they exist when shown
            createParticles();
            createLegend();
            // set initial progress to 0
            setProgress(0);
        })();
    </script>

    <!-- === Main app script (firebase + page logic) === -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getDatabase, ref, get, child } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAuhNKygw6dv8jqfNY8qnmIrX-TsLy2jvI",
            authDomain: "dairy-app-abhijit.firebaseapp.com",
            databaseURL: "https://dairy-app-abhijit-default-rtdb.firebaseio.com",
            projectId: "dairy-app-abhijit",
            storageBucket: "dairy-app-abhijit.appspot.com",
            messagingSenderId: "196152880143",
            appId: "1:196152880143:web:bec02170e30932a7d5877a"
        };

        const app = initializeApp(firebaseConfig);
        const database = getDatabase();
        const dbRef = ref(database);

        // --- State ---
        let currentDateRange = '';
        let currentBaseDate = new Date();      // month/year used when building ranges & display
        let adjustedBaseDate = null;          // will hold today - 5 (used when day <= 5 to show previous month)
        let allNames = new Set();
        let databaseData = {};

        // Conversion factors
        const conversionFactor_ToMake_original = 41.10 / 29;
        const conversionFactor_ToMake_original_Less = 29 / 41.10;

        // Fixed names always appear first
        const fixedNames = ['‡¶ö‡¶®‡ßç‡¶¶‡¶®‡¶æ ‡¶ò‡ßã‡¶∑.', '‡¶∞‡¶æ‡¶ú‡ßá‡¶®‡ßç‡¶¶‡ßç‡¶∞ ‡¶ò‡ßã‡¶∑'];

        // Pre-selected names
        const preselectedNames = [
            '‡¶Æ‡¶ß‡ßÅ‡¶Æ‡¶ø‡¶§‡¶æ ‡¶Æ‡¶®‡ßç‡¶°‡¶≤',
            '‡¶∞‡¶ú‡¶ø‡¶®‡¶æ ‡¶∂‡ßá‡¶ñ',
            '‡¶¨‡¶ø‡¶ú‡¶≤‡¶æ ‡¶¶‡ßÅ‡¶≤‡ßá',
            '‡¶∏‡ßÅ‡¶¶‡¶∞‡ßç‡¶∂‡¶® ‡¶ò‡ßã‡¶∑',
            '‡¶Æ‡¶Æ‡¶§‡¶æ ‡¶ò‡ßã‡¶∑',
            '‡¶ù‡¶∞‡ßç‡¶®‡¶æ ‡¶ö‡¶ö‡ßç‡¶ö‡¶°‡¶º‡¶ø',
            '‡¶∏‡ßÅ‡¶≤‡ßã‡¶ö‡¶®‡¶æ ‡¶ò‡ßã‡¶∑',
            '‡¶¨‡ßÅ‡¶≤‡ßç‡¶ü‡¶ø ‡¶¶‡ßÅ‡¶≤‡ßá',
            '‡¶´‡¶æ‡¶á‡¶ú‡ßÅ‡¶≤ ‡¶Æ‡¶≤‡ßç‡¶≤‡¶ø‡¶ï'
        ];

        // --- Helpers ---
        function updateDateRangeButtons() {
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.range === currentDateRange);
            });
        }

        function updateDatedBillDisplay() {
            const base = new Date(currentBaseDate);
            const year = base.getFullYear();
            const month = base.getMonth(); // 0-based
            let startDay, endDay;

            switch (currentDateRange) {
                case '1-7': startDay = 1; endDay = 7; break;
                case '8-15': startDay = 8; endDay = 15; break;
                case '16-23': startDay = 16; endDay = 23; break;
                case '24-rest': startDay = 24; endDay = new Date(year, month + 1, 0).getDate(); break;
                default:
                    const elEmpty = document.querySelector('.dated_bill');
                    if (elEmpty) elEmpty.textContent = '';
                    return;
            }

            const formatDate = (d) => {
                const dd = String(d).padStart(2, '0');
                const mm = String(month + 1).padStart(2, '0');
                const yy = String(year).slice(-2);
                return `${dd}/${mm}/${yy}`;
            };

            const el = document.querySelector('.dated_bill');
            if (el) el.textContent = `${formatDate(startDay)} - ${formatDate(endDay)}`;
        }

        function getDatesInRange(range) {
            const base = new Date(currentBaseDate);
            const year = base.getFullYear();
            const month = base.getMonth();
            const dates = [];

            let startDay, endDay;

            switch (range) {
                case '1-7': startDay = 1; endDay = 7; break;
                case '8-15': startDay = 8; endDay = 15; break;
                case '16-23': startDay = 16; endDay = 23; break;
                case '24-rest': startDay = 24; endDay = new Date(year, month + 1, 0).getDate(); break;
                default: return dates;
            }

            for (let day = startDay; day <= endDay; day++) {
                // format matches your RTDB keys: "day-month-year"
                const formattedDate = `${day}-${month + 1}-${year}`;
                dates.push(formattedDate);
            }

            return dates;
        }

        function showLoading() {
            const tableBody = document.getElementById('tableBody');
            if (tableBody) tableBody.innerHTML = '<tr class="loading"><td colspan="4">Loading data...</td></tr>';
        }

        function showError(message) {
            const errorDiv = document.getElementById('errorMessage');
            if (errorDiv) errorDiv.innerHTML = `<div class="error">${message}</div>`;
        }

        function clearError() {
            const d = document.getElementById('errorMessage');
            if (d) d.innerHTML = '';
        }

        // --- Default date-range selection: compute adjustedBaseDate = today - 5 ---
        function setDefaultDateRange() {
            const today = new Date();
            const currentDay = today.getDate();

            // compute adjustedBaseDate (today - 5)
            const adjustedDate = new Date(today);
            adjustedDate.setDate(currentDay - 5);
            adjustedBaseDate = new Date(adjustedDate);

            // choose default range based on adjustedDate's day-of-month
            const adjDay = adjustedDate.getDate();
            let selectedRange = '';
            if (adjDay >= 1 && adjDay <= 7) selectedRange = '1-7';
            else if (adjDay >= 8 && adjDay <= 15) selectedRange = '8-15';
            else if (adjDay >= 16 && adjDay <= 23) selectedRange = '16-23';
            else selectedRange = '24-rest';

            currentDateRange = selectedRange;
            currentBaseDate = new Date(adjustedBaseDate); // default view references adjusted (previous) month/year
            updateDateRangeButtons();
            updateDatedBillDisplay();
        }

        // --- Event wiring: while today's date <= 5 use adjustedBaseDate (previous month); after that use current month ---
        function setupEventListeners() {
            document.querySelectorAll('.date-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const now = new Date();
                    // if new month day is 1..5, keep using adjustedBaseDate (previous month). Otherwise use current month.
                    if (now.getDate() <= 5 && adjustedBaseDate) {
                        currentBaseDate = new Date(adjustedBaseDate);
                    } else {
                        currentBaseDate = new Date(); // real current month/year
                    }

                    currentDateRange = this.dataset.range;
                    updateDateRangeButtons();
                    updateDatedBillDisplay();
                    // update data without showing big overlay
                    loadData(false);
                });
            });

            // allow pressing refresh button to reload without overlay
            const refreshBtn = document.querySelector('.refresh-btn');
            if (refreshBtn) refreshBtn.addEventListener('click', () => loadData(false));
        }

        // --- Data loader (reads from RTDB keys like "1-9-2025") ---
        // showOverlay: boolean - when true show the big loading overlay; otherwise only show small inline "Loading data..." row
        async function loadData(showOverlay = false) {
            try {
                // small inline table loading placeholder always
                showLoading();
                clearError();

                // show overlay only when requested
                if (showOverlay && window.LoadingScreen) {
                    try {
                        window.LoadingScreen.createParticles();
                        // ensure legend exists (createLegend) in case it's not created
                        if (typeof window.LoadingScreen.createLegend === 'function') window.LoadingScreen.createLegend();
                        window.LoadingScreen.show('Loading data', 'Fetching records...');
                        window.LoadingScreen.setProgress(5);
                    } catch (e) { console.warn('LoadingScreen failed to show:', e); }
                }

                const dates = getDatesInRange(currentDateRange);
                databaseData = {};
                allNames.clear();

                fixedNames.forEach(name => allNames.add(name));

                for (let i = 0; i < dates.length; i++) {
                    const date = dates[i];
                    try {
                        const snapshot = await get(child(dbRef, `records/${date}`));
                        if (snapshot.exists()) {
                            const dayData = snapshot.val();
                            Object.keys(dayData).forEach(nameKey => {
                                const personData = dayData[nameKey];
                                let actualName = nameKey;

                                Object.keys(personData).forEach(session => {
                                    if (personData[session] && personData[session].name) {
                                        actualName = personData[session].name;
                                    }
                                });

                                allNames.add(actualName);

                                if (!databaseData[actualName]) {
                                    databaseData[actualName] = { kg: 0, takaMain: 0 };
                                }

                                Object.keys(personData).forEach(session => {
                                    const sessionData = personData[session];
                                    if (sessionData && sessionData.kg && sessionData.total) {
                                        databaseData[actualName].kg += parseFloat(sessionData.kg) || 0;
                                        databaseData[actualName].takaMain += parseFloat(sessionData.total) || 0;
                                    }
                                });
                            });
                        }
                    } catch (error) {
                        console.warn(`Failed to load data for ${date}:`, error);
                    }

                    if (showOverlay && window.LoadingScreen) {
                        try {
                            const percent = dates.length ? Math.round(((i + 1) / dates.length) * 90) : 90;
                            window.LoadingScreen.setProgress(percent);
                        } catch (e) { /* ignore */ }
                    }
                }

                createNameCheckboxes();
                renderTable();

                // hide overlay only if we showed it
                if (showOverlay && window.LoadingScreen) {
                    try {
                        window.LoadingScreen.setProgress(100);
                        setTimeout(() => {
                            try { window.LoadingScreen.hide(); } catch (e) { /* ignore */ }
                        }, 300);
                    } catch (e) { console.warn('Failed to hide LoadingScreen:', e); }
                }

            } catch (error) {
                showError('Failed to load data: ' + (error && error.message ? error.message : error));
                console.error('Error loading data:', error);
                if (showOverlay && window.LoadingScreen) {
                    try { window.LoadingScreen.hide(); } catch (e) { /* ignore */ }
                }
            }
        }

        // --- Checkbox UI builder ---
        function createNameCheckboxes() {
            const checkboxContainer = document.getElementById('nameCheckboxes');
            if (!checkboxContainer) return;
            checkboxContainer.innerHTML = '';

            const sortedNames = Array.from(allNames).sort();
            const fixedNamesList = sortedNames.filter(name => fixedNames.includes(name));
            const otherNamesList = sortedNames.filter(name =>
                !fixedNames.includes(name) && !preselectedNames.includes(name)
            );

            let counter = 1;

            fixedNamesList.forEach(name => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'checkbox-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `checkbox_${counter}_${name}`;
                checkbox.value = name;
                checkbox.checked = true;
                checkbox.addEventListener('change', renderTable);

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = `${counter}. ${name}`;
                counter++;

                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                checkboxContainer.appendChild(checkboxDiv);
            });

            preselectedNames.forEach(name => {
                if (allNames.has(name)) {
                    const checkboxDiv = document.createElement('div');
                    checkboxDiv.className = 'checkbox-item';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `checkbox_${counter}_${name}`;
                    checkbox.value = name;
                    checkbox.checked = true;
                    checkbox.addEventListener('change', renderTable);

                    const label = document.createElement('label');
                    label.htmlFor = checkbox.id;
                    label.textContent = `${counter}. ${name}`;
                    counter++;

                    checkboxDiv.appendChild(checkbox);
                    checkboxDiv.appendChild(label);
                    checkboxContainer.appendChild(checkboxDiv);
                }
            });

            otherNamesList.forEach(name => {
                const checkboxDiv = document.createElement('div');
                checkboxDiv.className = 'checkbox-item';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `checkbox_${counter}_${name}`;
                checkbox.value = name;
                checkbox.checked = false;
                checkbox.addEventListener('change', renderTable);

                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = `${counter}. ${name}`;
                counter++;

                checkboxDiv.appendChild(checkbox);
                checkboxDiv.appendChild(label);
                checkboxContainer.appendChild(checkboxDiv);
            });
        }

        function getSelectedNames() {
            const checkboxes = document.querySelectorAll('#nameCheckboxes input[type="checkbox"]:checked');
            return Array.from(checkboxes).map(cb => cb.value);
        }

        // --- Table rendering ---
        function renderTable() {
            const tableBody = document.getElementById('tableBody');
            if (!tableBody) return;
            const selectedNames = getSelectedNames();
            tableBody.innerHTML = '';

            const billKg = parseFloat(document.getElementById('billKg').value) || 0;
            const billTotalRupee = parseFloat(document.getElementById('billTotalRupee').value) || 0;

            const databaseRows = [];
            let databasePeopleTotalKg = 0;
            let databasePeopleTotalTakaLess = 0;
            let databasePeopleTotalTakaMain = 0;

            selectedNames.forEach(name => {
                if (!fixedNames.includes(name)) {
                    const data = databaseData[name] || { kg: 0, takaMain: 0 };
                    const takaLessInt = Math.ceil((data.takaMain || 0) * conversionFactor_ToMake_original_Less);
                    databaseRows.push({ name, kg: data.kg || 0, takaMain: data.takaMain || 0, takaLess: takaLessInt });
                    databasePeopleTotalKg += data.kg || 0;
                    databasePeopleTotalTakaLess += takaLessInt;
                    databasePeopleTotalTakaMain += data.takaMain || 0;
                }
            });

            const remainingKg = billKg - databasePeopleTotalKg;
            let remainingTakaLess = Math.round(billTotalRupee - databasePeopleTotalTakaLess);

            const selectedFixed = fixedNames.filter(n => selectedNames.includes(n));
            const nFixed = selectedFixed.length;

            if (remainingTakaLess < 0) {
                remainingTakaLess = 0;
                showError('Warning: Please input the bill KG & TOTAL.');
            } else {
                clearError();
            }

            // --- Fixed allocation: 60/40 for two fixed names, fallback otherwise ---
            const fixedAlloc = {};

            if (nFixed > 0) {
                if (nFixed === 1) {
                    // single fixed person gets everything
                    const share = remainingTakaLess;
                    fixedAlloc[selectedFixed[0]] = {
                        takaLess: share,
                        takaMain: share * conversionFactor_ToMake_original,
                        kg: remainingKg
                    };
                } else if (nFixed === 2) {
                    // 60% / 40% split (first selected fixed gets 60%)
                    const perc = [0.6, 0.4];

                    // Compute taka shares using rounding but ensure sum == remainingTakaLess
                    const firstShare = Math.round(remainingTakaLess * perc[0]);
                    const secondShare = remainingTakaLess - firstShare; // exact remainder ensures total correct

                    fixedAlloc[selectedFixed[0]] = {
                        takaLess: firstShare,
                        takaMain: firstShare * conversionFactor_ToMake_original,
                        kg: remainingKg * perc[0]
                    };

                    fixedAlloc[selectedFixed[1]] = {
                        takaLess: secondShare,
                        takaMain: secondShare * conversionFactor_ToMake_original,
                        kg: remainingKg * perc[1]
                    };
                } else {
                    // fallback: even split for >2 fixed names (keeps previous logic)
                    const baseShare = Math.floor(remainingTakaLess / nFixed);
                    let remainder = remainingTakaLess % nFixed;
                    selectedFixed.forEach(name => {
                        let share = baseShare + (remainder > 0 ? 1 : 0);
                        if (remainder > 0) remainder--;
                        fixedAlloc[name] = {
                            takaLess: share,
                            takaMain: share * conversionFactor_ToMake_original,
                            kg: remainingKg / nFixed
                        };
                    });
                }
            }

            // --- Render fixed rows using fixedAlloc's kg values (not a single fixedKgEach) ---
            let totalKg = 0, totalTakaLess = 0, totalTakaMain = 0;

            selectedFixed.forEach(name => {
                const alloc = fixedAlloc[name] || { takaLess: 0, takaMain: 0, kg: 0 };
                const row = createTableRow(name, alloc.kg, alloc.takaMain, true, alloc.takaLess);
                tableBody.appendChild(row);
                totalKg += alloc.kg;
                totalTakaLess += alloc.takaLess;
                totalTakaMain += alloc.takaMain;
            });


            databaseRows.forEach(item => {
                const row = createTableRow(item.name, item.kg, item.takaMain, false, item.takaLess);
                tableBody.appendChild(row);
                totalKg += item.kg;
                totalTakaLess += item.takaLess;
                totalTakaMain += item.takaMain;
            });

            const elTotalKg = document.getElementById('totalKg');
            const elTotalTakaLess = document.getElementById('totalTakaLess');
            const elTotalTakaMain = document.getElementById('totalTakaMain');

            if (elTotalKg) elTotalKg.textContent = totalKg.toFixed(1);
            if (elTotalTakaLess) elTotalTakaLess.textContent = Number(totalTakaLess).toFixed(0);
            if (elTotalTakaMain) elTotalTakaMain.textContent = totalTakaMain.toFixed(0);
        }

        function createTableRow(name, kg, takaMain, isFixed, providedTakaLess = null) {
            const row = document.createElement('tr');
            row.className = isFixed ? 'fixed-row' : 'database-row';
            const takaLess = (providedTakaLess !== null)
                ? providedTakaLess
                : Math.ceil((takaMain || 0) * conversionFactor_ToMake_original_Less);

            row.innerHTML = `
        <td>${name}</td>
        <td class="numeric">${(kg || 0).toFixed(1)}</td>
        <td class="numeric">${Number(takaLess).toFixed(0)}</td>
        <td class="numeric">${(takaMain || 0).toFixed(0)}</td>
    `;
            return row;
        }

        // --- Screenshot (updated filename format) ---
        window.downloadTableScreenshot = async function () {
            const downloadBtn = document.getElementById('downloadBtn');
            const tableContainer = document.getElementById('tableContainer');

            if (downloadBtn) {
                downloadBtn.disabled = true;
                downloadBtn.textContent = 'üì∏ Capturing Screenshot...';
            }

            try {
                const canvas = await html2canvas(tableContainer, {
                    backgroundColor: '#ffffff',
                    scale: 2,
                    useCORS: true,
                    allowTaint: true,
                    height: tableContainer.scrollHeight,
                    width: tableContainer.scrollWidth,
                    scrollX: 0,
                    scrollY: 0
                });

                canvas.toBlob(function (blob) {
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');

                    // Determine base date for month label (use currentBaseDate if present, otherwise today)
                    let baseDate = (typeof currentBaseDate !== 'undefined' && currentBaseDate) ? new Date(currentBaseDate) : new Date();

                    // Month-Year like "Sep-2025"
                    const monthYear = baseDate.toLocaleString('en-US', { month: 'long', year: 'numeric' }).replace(' ', '-');

                    // Try to get active date-range button label (falls back to currentDateRange)
                    let activeBtnLabel = '';
                    const activeBtn = document.querySelector('.date-btn.active') || document.querySelector('.date-btn[data-range="' + (currentDateRange || '') + '"]');
                    if (activeBtn) activeBtnLabel = activeBtn.textContent.trim();
                    if (!activeBtnLabel) activeBtnLabel = currentDateRange || 'range';

                    // Sanitize label for filenames: replace spaces with underscore, remove unsafe chars
                    const sanitize = s => String(s).trim().replace(/\s+/g, '_').replace(/[<>:"\/\\|?*\x00-\x1F]/g, '');

                    const sanitizedLabel = sanitize(activeBtnLabel);
                    const sanitizedRange = sanitize(currentDateRange || activeBtnLabel);

                    // final filename: bill_<button_label> (<range>)_<Mon-Year>.jpg
                    const filename = `bill_(${sanitizedRange})_${monthYear}.jpg`;

                    link.href = url;
                    link.download = filename;

                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);

                    URL.revokeObjectURL(url);

                    if (downloadBtn) {
                        downloadBtn.disabled = false;
                        downloadBtn.textContent = 'üì∑ Download Table Screenshot';
                    }
                }, 'image/jpeg', 0.95);

            } catch (error) {
                console.error('Error capturing screenshot:', error);
                alert('Failed to capture screenshot. Please try again.');
                if (downloadBtn) {
                    downloadBtn.disabled = false;
                    downloadBtn.textContent = 'üì∑ Download Table Screenshot';
                }
            }
        };


        // Expose helpers to window
        // default showOverlay = false so calling loadData() from markup won't trigger overlay
        window.loadData = (showOverlay = false) => loadData(showOverlay);
        window.updateTable = function () { renderTable(); };

        // Initialize on load (functions are already defined above)
        window.onload = function () {
            setDefaultDateRange();   // default uses today - 5 as reference month/year
            setupEventListeners();   // clicking buttons uses adjustedBaseDate while day <= 5
            // Show overlay only on initial page load:
            loadData(true);
        };
    </script>



</body>

</html>