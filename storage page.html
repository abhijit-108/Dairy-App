<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bills Upload to Firebase Storage</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Lato', sans-serif;
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d30 100%);
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            text-align: center;
        }

        .content-box {
            width: 310px;
            margin: 10px auto;
            padding: 20px;
            background: rgba(40, 40, 40, 0.9);
            border: 1px solid #555;
            border-radius: 12px;
            display: grid;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .disabled {
            display: none;
        }

        h1 {
            font-size: 28px;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            background: linear-gradient(45deg, #64b5f6, #42a5f5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        input[type="file"],
        select {
            margin: 10px;
            padding: 12px 16px;
            border: 2px solid #555;
            border-radius: 8px;
            font-size: 16px;
            width: calc(100% - 40px);
            max-width: 300px;
            background-color: #2d2d30;
            color: #e0e0e0;
            transition: all 0.3s ease;
        }

        input[type="file"]:focus,
        select:focus {
            outline: none;
            border-color: #64b5f6;
            box-shadow: 0 0 10px rgba(100, 181, 246, 0.3);
        }

        input[type="file"]:hover,
        select:hover {
            border-color: #777;
        }

        #backtomain {
            position: fixed;
            right: 20px;
            top: 20px;
            padding: 12px 20px;
            background: linear-gradient(45deg, #ffd54f, #ffca28);
            font-weight: bold;
            color: #1e1e1e;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(255, 213, 79, 0.3);
        }

        #backtomain:hover {
            background: linear-gradient(45deg, #ff8a65, #ff7043);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 138, 101, 0.4);
        }

        #uploadButton {
            background: linear-gradient(45deg, #66bb6a, #4caf50);
            color: white;
            border: none;
            cursor: pointer;
            padding: 12px 18px;
            width: 160px;
            margin-top: 20px;
            font-size: 16px;
            font-weight: bold;
            margin-left: auto;
            margin-right: auto;
            transition: all 0.3s ease;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
        }

        #uploadButton:hover {
            background: linear-gradient(45deg, #ef5350, #f44336);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
        }

        #uploadButton:active {
            transform: translateY(0);
        }

        #status {
            color: #ff8a80;
            margin-top: 15px;
            font-size: 16px;
            font-weight: 500;
        }

        #progressBar {
            width: 100%;
            max-width: 300px;
            height: 8px;
            background-color: #333;
            margin: 15px auto;
            display: none;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #progress {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #66bb6a);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        #photoContainer {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(30, 30, 30, 0.8);
            padding: 30px 0;
            backdrop-filter: blur(10px);
        }

        .display-box {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }

        .photoBox {
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            background: rgba(45, 45, 48, 0.9);
            border-radius: 12px;
            margin: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .photoBox:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            border-color: rgba(100, 181, 246, 0.5);
        }

        @media (min-width: 768px) {
            .photoBox {
                width: 500px;
            }
        }

        .photoBox img {
            width: 100%;
            height: auto;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .photoBox:hover img {
            transform: scale(1.05);
        }

        .comment {
            margin: 15px 0;
            font-size: 18px;
            font-weight: bold;
            color: #b0b0b0;
            padding: 0 15px;
        }

        .downloadButton {
            margin: 15px 0 20px 0;
            padding: 12px 20px;
            font-size: 15px;
            font-weight: bold;
            background: linear-gradient(45deg, #ff7043, #ff5722);
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(255, 87, 34, 0.3);
        }

        .downloadButton:hover {
            background: linear-gradient(45deg, #66bb6a, #4caf50);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        footer {
            text-align: center;
            padding: 15px;
            background: rgba(20, 20, 20, 0.8);
            margin-top: 30px;
            color: #888;
        }

        @media (min-width: 768px) {
            .photoBox {
                width: calc(50% - 40px);
            }
        }

        /* Custom file input styling */
        input[type="file"]::file-selector-button {
            background: linear-gradient(45deg, #64b5f6, #42a5f5);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            margin-right: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        input[type="file"]::file-selector-button:hover {
            background: linear-gradient(45deg, #42a5f5, #2196f3);
            transform: translateY(-1px);
        }

        /* Select dropdown styling */
        select option {
            background-color: #2d2d30;
            color: #e0e0e0;
        }
    </style>
</head>

<body>
    <h1>Upload Photo to Firebase Storage</h1>
    <br><button id="backtomain">Main Page</button>
    <div id="content_box" class="content-box">
        <input type="file" id="fileInput">
        <select id="commentInput">
            <option value="01_currentmonth_currentyear-07_currentmonth_currentyear">1 to 7</option>
            <option value="08_currentmonth_currentyear-15_currentmonth_currentyear">8 to 15</option>
            <option value="16_currentmonth_currentyear-23_currentmonth_currentyear">16 to 23</option>
            <option value="24_currentmonth_currentyear-rest">24 to rest</option>
        </select>
        <select id="monthSelect">
            <option value="current">Current Month</option>
            <option value="previous">Previous Month</option>
        </select>

        <button id="uploadButton">Upload</button>
        <p id="status"></p>
        <div id="progressBar" class="progress-bar">
            <div id="progress" class="progress"></div>
        </div>
    </div>

    <div id="photoContainer">
        <div class="display-box" id="displayBox">
            <!-- Photos and comments will be displayed here -->
        </div>
    </div>
    <!-- Firebase SDKs -->
    <script>
        // Get the button element
        var billButton = document.getElementById('backtomain');

        // Add a click event listener to the button
        billButton.addEventListener('click', function () {
            // Redirect to bill.html
            window.location.href = 'index.html';
        });
    </script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getStorage, ref, uploadBytesResumable, listAll, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAuhNKygw6dv8jqfNY8qnmIrX-TsLy2jvI",
            authDomain: "dairy-app-abhijit.firebaseapp.com",
            databaseURL: "https://dairy-app-abhijit-default-rtdb.firebaseio.com",
            projectId: "dairy-app-abhijit",
            storageBucket: "dairy-app-abhijit.appspot.com",
            messagingSenderId: "196152880143",
            appId: "1:196152880143:web:bec02170e30932a7d5877a"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);
        const auth = getAuth();

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const commentInput = document.getElementById('commentInput');
            const monthSelect = document.getElementById('monthSelect');
            const file = fileInput.files[0];
            const commentOption = commentInput.value.trim();
            const monthOption = monthSelect.value; // Get the selected month option

            if (!file) {
                document.getElementById('status').textContent = 'No file selected!';
                return;
            }

            // Generate comment based on selected option
            const currentDate = new Date();
            let targetDate = new Date(); // Default to current month

            if (monthOption === 'previous') {
                targetDate.setMonth(currentDate.getMonth() - 1); // Set to previous month
            }

            const targetMonth = ('0' + (targetDate.getMonth() + 1)).slice(-2); // Zero-padded month
            const targetYear = targetDate.getFullYear();

            let comment;
            switch (commentOption) {
                case '01_currentmonth_currentyear-07_currentmonth_currentyear':
                    comment = `01-${targetMonth}-${targetYear} 07-${targetMonth}-${targetYear}`;
                    break;
                case '08_currentmonth_currentyear-15_currentmonth_currentyear':
                    comment = `08-${targetMonth}-${targetYear} 15-${targetMonth}-${targetYear}`;
                    break;
                case '16_currentmonth_currentyear-23_currentmonth_currentyear':
                    comment = `16-${targetMonth}-${targetYear} 23-${targetMonth}-${targetYear}`;
                    break;
                case '24_currentmonth_currentyear-rest':
                    comment = `24-${targetMonth}-${targetYear} rest`;
                    break;
                default:
                    comment = ''; // Handle default case if necessary
                    break;
            }

            if (!comment) {
                document.getElementById('status').textContent = 'Invalid comment option!';
                return;
            }

            // Append comment to file name
            const fileName = `${comment}_${file.name}`;
            const fileRef = ref(storage, `uploads/${fileName}`);

            // Upload the file with progress tracking
            const uploadTask = uploadBytesResumable(fileRef, file);

            const progressBar = document.getElementById('progressBar');
            const progress = document.getElementById('progress');
            progressBar.style.display = 'block'; // Show progress bar

            uploadTask.on('state_changed',
                (snapshot) => {
                    // Progress function
                    const percentage = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progress.style.width = percentage + '%';
                },
                (error) => {
                    // Error function
                    document.getElementById('status').textContent = 'Upload failed: ' + error.message;
                    console.error('Upload failed:', error);
                },
                () => {
                    // Completion function
                    document.getElementById('status').textContent = 'Upload successful!';
                    displayPhotos(); // Refresh the displayed photos after a new upload

                    // Reset progress bar
                    progress.style.width = '0%';
                    progressBar.style.display = 'none'; // Hide progress bar
                }
            );
        }

        async function displayPhotos() {
            const displayBox = document.getElementById('displayBox');
            displayBox.innerHTML = ''; // Clear the display box

            // List all files in the 'uploads' folder
            const listRef = ref(storage, 'uploads/');
            const listResult = await listAll(listRef);

            // Custom sorting function based on date range
            const sortByDateRange = (fileName) => {
                const dateRangeString = fileName.split('_')[0]; // Assuming date range is at the beginning of the file name
                const startDateString = dateRangeString.split(' ')[0]; // Get the start date part
                const [day, month, year] = startDateString.split('-'); // Split by '-' assuming "DD-MM-YYYY" format
                return new Date(year, month - 1, day); // Return Date object for sorting
            };

            // Sort files based on date range
            listResult.items.sort((a, b) => {
                const dateA = sortByDateRange(a.name);
                const dateB = sortByDateRange(b.name);
                return dateB - dateA; // Descending order (latest date first)
            });

            // Display sorted files
            for (let i = 0; i < listResult.items.length; i++) {
                const itemRef = listResult.items[i];
                try {
                    const url = await getDownloadURL(itemRef);

                    const photoBox = document.createElement('div');
                    photoBox.classList.add('photoBox');

                    const imgElement = document.createElement('img');
                    imgElement.src = url;

                    const fileName = document.createElement('p');
                    fileName.classList.add('comment');
                    fileName.textContent = itemRef.name.split('_')[0].replace(/_/g, ' '); // Display comment as formatted string

                    const downloadButton = document.createElement('button');
                    downloadButton.classList.add('downloadButton');
                    downloadButton.textContent = 'Download';
                    downloadButton.addEventListener('click', () => {
                        downloadFile(url, itemRef.name);
                    });

                    photoBox.appendChild(imgElement);
                    photoBox.appendChild(fileName);
                    photoBox.appendChild(downloadButton);
                    displayBox.appendChild(photoBox);
                } catch (error) {
                    console.error('Error getting download URL:', error);
                }
            }
        }

        function downloadFile(url, fileName) {
            fetch(url)
                .then(response => response.blob())
                .then(blob => {
                    const blobUrl = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = blobUrl;
                    a.download = fileName; // Set the file name for download
                    document.body.appendChild(a);
                    a.click(); // Simulate click on the anchor tag
                    document.body.removeChild(a); // Clean up
                    URL.revokeObjectURL(blobUrl); // Clean up the Blob URL
                })
                .catch(error => {
                    console.error('Error downloading file:', error);
                });
        }

        // Event listener for the upload button
        const uploadButton = document.getElementById('uploadButton');
        uploadButton.addEventListener('click', uploadFile);

        // Display photos on initial load
        window.onload = displayPhotos;

        onAuthStateChanged(auth, (user) => {
            const content_box = document.getElementById('content_box');

            if (user) {
                content_box.classList.remove('disabled');

            } else {
                content_box.classList.add('disabled');
            }
        });

    </script>
</body>

</html>