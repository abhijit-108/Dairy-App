<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bills Photos</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* Loading Screen Styles */
        #loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(30, 30, 30, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }

        #loading-screen.hidden {
            opacity: 0;
            visibility: hidden;
        }

        .loading-container {
            text-align: center;
            color: #e0e0e0;
            animation: fadeInUp 0.8s ease-out;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 3rem 2rem;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .loading-icon {
            font-size: 4rem;
            margin-bottom: 2rem;
            animation: bounce 2s infinite;
            color: #64b5f6;
        }

        @keyframes bounce {

            0%,
            20%,
            50%,
            80%,
            100% {
                transform: translateY(0);
            }

            40% {
                transform: translateY(-20px);
            }

            60% {
                transform: translateY(-10px);
            }
        }

        .loading-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 1rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            color: #ffffff;
        }

        .loading-subtitle {
            font-size: 1.1rem;
            margin-bottom: 3rem;
            opacity: 0.8;
            font-weight: 400;
            color: #b0b0b0;
        }

        .progress-container {
            width: 300px;
            max-width: 80vw;
            margin: 0 auto;
        }

        .progress-bar-bg {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50px;
            overflow: hidden;
            margin-bottom: 1rem;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #64b5f6, #42a5f5);
            border-radius: 50px;
            width: 0%;
            transition: width 0.3s ease;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(100, 181, 246, 0.3);
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.5), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        .progress-text {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #ffffff;
        }

        .progress-status {
            font-size: 0.9rem;
            opacity: 0.7;
            font-style: italic;
            color: #b0b0b0;
        }

        .loading-dots {
            display: inline-block;
        }

        .loading-dots::after {
            content: '';
            animation: dots 2s infinite;
        }

        @keyframes dots {

            0%,
            20% {
                content: '';
            }

            40% {
                content: '.';
            }

            60% {
                content: '..';
            }

            80%,
            100% {
                content: '...';
            }
        }

        /* Mobile responsiveness for loading screen */
        @media (max-width: 768px) {
            .loading-title {
                font-size: 1.5rem;
            }

            .loading-subtitle {
                font-size: 1rem;
            }

            .loading-icon {
                font-size: 3rem;
            }

            .progress-container {
                width: 250px;
            }
        }

        body {
            font-family: 'Lato', sans-serif;
            background: linear-gradient(135deg, #1e1e1e 0%, #2d2d30 100%);
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            text-align: center;
        }

        .content-box {
            width: 310px;
            margin: 10px auto;
            padding: 20px;
            background: rgba(40, 40, 40, 0.9);
            border: 1px solid #555;
            border-radius: 12px;
            display: grid;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .disabled {
            display: none;
        }

        h1 {
            font-size: 28px;
            margin-top: 20px;
            margin-bottom: 10px;
            color: #ffffff;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            background: linear-gradient(45deg, #64b5f6, #42a5f5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        input[type="file"],
        select {
            margin: 10px;
            padding: 12px 16px;
            border: 2px solid #555;
            border-radius: 8px;
            font-size: 16px;
            width: calc(100% - 40px);
            max-width: 300px;
            background-color: #2d2d30;
            color: #e0e0e0;
            transition: all 0.3s ease;
        }

        input[type="file"]:focus,
        select:focus {
            outline: none;
            border-color: #64b5f6;
            box-shadow: 0 0 10px rgba(100, 181, 246, 0.3);
        }

        input[type="file"]:hover,
        select:hover {
            border-color: #777;
        }

        #backtomain {
            position: fixed;
            right: 20px;
            top: 20px;
            padding: 12px 20px;
            background: linear-gradient(45deg, #ffd54f, #ffca28);
            font-weight: bold;
            color: #1e1e1e;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(255, 213, 79, 0.3);
        }

        #backtomain:hover {
            background: linear-gradient(45deg, #ff8a65, #ff7043);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 138, 101, 0.4);
        }

        #uploadButton {
            background: linear-gradient(45deg, #66bb6a, #4caf50);
            color: white;
            border: none;
            cursor: pointer;
            padding: 12px 18px;
            width: 160px;
            margin-top: 20px;
            font-size: 16px;
            font-weight: bold;
            margin-left: auto;
            margin-right: auto;
            transition: all 0.3s ease;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(76, 175, 80, 0.3);
        }

        #uploadButton:hover {
            background: linear-gradient(45deg, #ef5350, #f44336);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(244, 67, 54, 0.4);
        }

        #uploadButton:active {
            transform: translateY(0);
        }

        #status {
            color: #ff8a80;
            margin-top: 15px;
            font-size: 16px;
            font-weight: 500;
        }

        #progressBar {
            width: 100%;
            max-width: 300px;
            height: 8px;
            background-color: #333;
            margin: 15px auto;
            display: none;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        #progress {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #66bb6a);
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        /* upload speed text directly below upload progress bar */
        #uploadSpeed {
            margin-top: 6px;
            font-size: 0.9rem;
            color: #cfe8d8;
            opacity: 0.95;
            min-height: 1.1em;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
            display: none;
            font-weight: 600;
        }

        #photoContainer {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: rgba(30, 30, 30, 0.8);
            padding: 30px 0;
            backdrop-filter: blur(10px);
        }

        .display-box {
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            margin-top: 20px;
        }

        .photoBox {
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            background: rgba(45, 45, 48, 0.9);
            border-radius: 12px;
            margin: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .photoBox:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6);
            border-color: rgba(100, 181, 246, 0.5);
        }

        @media (min-width: 768px) {
            .photoBox {
                width: 500px;
            }
        }

        .photoBox img {
            width: 100%;
            height: auto;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .photoBox:hover img {
            transform: scale(1.05);
        }

        .comment {
            margin: 15px 0;
            font-size: 18px;
            font-weight: bold;
            color: #b0b0b0;
            padding: 0 15px;
        }

        .downloadButton {
            margin: 15px 0 20px 0;
            padding: 12px 20px;
            font-size: 15px;
            font-weight: bold;
            background: linear-gradient(45deg, #ff7043, #ff5722);
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s ease;
            box-shadow: 0 4px 16px rgba(255, 87, 34, 0.3);
        }

        .downloadButton:hover {
            background: linear-gradient(45deg, #66bb6a, #4caf50);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
        }

        footer {
            text-align: center;
            padding: 15px;
            background: rgba(20, 20, 20, 0.8);
            margin-top: 30px;
            color: #888;
        }

        @media (min-width: 768px) {
            .photoBox {
                width: calc(50% - 40px);
            }
        }

        /* Custom file input styling */
        input[type="file"]::file-selector-button {
            background: linear-gradient(45deg, #64b5f6, #42a5f5);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            margin-right: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        input[type="file"]::file-selector-button:hover {
            background: linear-gradient(45deg, #42a5f5, #2196f3);
            transform: translateY(-1px);
        }

        /* Select dropdown styling */
        select option {
            background-color: #2d2d30;
            color: #e0e0e0;
        }

        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {

            *,

            *::before,

            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Loading spinner for infinite scroll */
        .scroll-loader {
            display: none;
            width: 100%;
            text-align: center;
            padding: 20px;
        }

        .scroll-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            border-top: 4px solid #64b5f6;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <!-- Loading Screen -->
    <div id="loading-screen">
        <div class="loading-container">
            <div class="loading-icon">
                <i class="fas fa-file-upload" aria-hidden="true"></i>
            </div>
            <h1 class="loading-title">Bills Upload System</h1>
            <p class="loading-subtitle">Loading your file management system<span class="loading-dots"></span></p>
            <div class="progress-container">
                <div class="progress-bar-bg">
                    <div class="progress-bar" id="progress-bar"></div>
                </div>
                <div class="progress-text" id="progress-text">0%</div>
                <div class="progress-status" id="progress-status">Initializing application...</div>
            </div>
        </div>
    </div>

    <h1>Upload Bills</h1>
    <br><button id="backtomain">Main Page</button>
    <div id="content_box" class="content-box">
        <input type="file" id="fileInput">
        <select id="commentInput">
            <option value="01_currentmonth_currentyear-07_currentmonth_currentyear">1 to 7</option>
            <option value="08_currentmonth_currentyear-15_currentmonth_currentyear">8 to 15</option>
            <option value="16_currentmonth_currentyear-23_currentmonth_currentyear">16 to 23</option>
            <option value="24_currentmonth_currentyear-rest">24 to rest</option>
        </select>
        <select id="monthSelect">
            <option value="current">Current Month</option>
            <option value="previous">Previous Month</option>
        </select>

        <button id="uploadButton">Upload</button>
        <p id="status"></p>
        <div id="progressBar" class="progress-bar">
            <div id="progress" class="progress"></div>
        </div>
        <!-- Upload speed / bytes info shown below the upload progress bar -->
        <div id="uploadSpeed"></div>
    </div>

    <div id="photoContainer">
        <div class="display-box" id="displayBox">
            <!-- Photos and comments will be displayed here -->
        </div>
        <div class="scroll-loader" id="scrollLoader">
            <div class="scroll-spinner"></div>
            <p>Loading more files...</p>
        </div>
    </div>
    <!-- Firebase SDKs -->
    <script>
        // Get the button element
        var billButton = document.getElementById('backtomain');

        // Add a click event listener to the button
        billButton.addEventListener('click', function () {
            // Redirect to bill.html
            window.location.href = 'index.html';
        });

        // Auto-select commentInput using (baseDate - 5 days).
// baseDate = today if monthSelect === 'current'
// baseDate = same day-of-month but previous month if monthSelect === 'previous'
function autoSelectComment() {
    const commentInput = document.getElementById('commentInput');
    const monthSelect = document.getElementById('monthSelect');
    if (!commentInput || !monthSelect) return;

    const today = new Date();

    // choose base date depending on monthSelect
    let baseDate;
    if (monthSelect.value === 'previous') {
        // same day-of-month but previous month
        // using Date(year, month-1, day) handles short months safely
        baseDate = new Date(today.getFullYear(), today.getMonth() - 1, today.getDate());
    } else {
        baseDate = new Date(today);
    }

    // reference date = baseDate - 5 days
    const refDate = new Date(baseDate);
    refDate.setDate(refDate.getDate() - 5);

    const day = refDate.getDate();

    let valueToSelect = '24_currentmonth_currentyear-rest'; // fallback
    if (day >= 1 && day <= 7) {
        valueToSelect = '01_currentmonth_currentyear-07_currentmonth_currentyear';
    } else if (day >= 8 && day <= 15) {
        valueToSelect = '08_currentmonth_currentyear-15_currentmonth_currentyear';
    } else if (day >= 16 && day <= 23) {
        valueToSelect = '16_currentmonth_currentyear-23_currentmonth_currentyear';
    } else {
        valueToSelect = '24_currentmonth_currentyear-rest';
    }

    commentInput.value = valueToSelect;
}

// run on DOM ready and whenever monthSelect changes
document.addEventListener('DOMContentLoaded', autoSelectComment);
const monthSelectEl = document.getElementById('monthSelect');
if (monthSelectEl) monthSelectEl.addEventListener('change', autoSelectComment);

        
    </script>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getStorage, ref, uploadBytesResumable, listAll, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-storage.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAuhNKygw6dv8jqfNY8qnmIrX-TsLy2jvI",
            authDomain: "dairy-app-abhijit.firebaseapp.com",
            databaseURL: "https://dairy-app-abhijit-default-rtdb.firebaseio.com",
            projectId: "dairy-app-abhijit",
            storageBucket: "dairy-app-abhijit.appspot.com",
            messagingSenderId: "196152880143",
            appId: "1:196152880143:web:bec02170e30932a7d5877a"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const storage = getStorage(app);
        const auth = getAuth();

        // Variables for infinite scroll
        let allItems = [];
        let currentIndex = 0;
        const itemsPerLoad = 6; // Number of items to load at a time
        let isLoading = false;

        // Loading Progress Management
        let currentProgress = 0;
        let isDataLoaded = false;
        let progressInterval;
        let loadingTimeout;

        // Progress stages with status messages
        const progressStages = [
            { progress: 10, status: "Initializing Firebase connection..." },
            { progress: 25, status: "Authenticating user..." },
            { progress: 40, status: "Loading storage system..." },
            { progress: 60, status: "Fetching existing files..." },
            { progress: 80, status: "Preparing upload interface..." },
            { progress: 95, status: "Finalizing setup..." },
            { progress: 100, status: "Complete! Ready to upload files." }
        ];

        // Function to update progress bar
        function updateProgress(targetProgress, status) {
            const progressBar = document.getElementById('progress-bar');
            const progressText = document.getElementById('progress-text');
            const progressStatus = document.getElementById('progress-status');

            // Smooth animation to target progress
            const currentProgressValue = parseInt(progressBar.style.width) || 0;
            const progressStep = (targetProgress - currentProgressValue) / 20;

            let stepProgress = currentProgressValue;
            const progressAnimation = setInterval(() => {
                stepProgress += progressStep;
                if (stepProgress >= targetProgress) {
                    stepProgress = targetProgress;
                    clearInterval(progressAnimation);
                }

                progressBar.style.width = stepProgress + '%';
                progressText.textContent = Math.round(stepProgress) + '%';

                if (status) {
                    progressStatus.textContent = status;
                }
            }, 20);

            currentProgress = targetProgress;
        }

        // Auto-progress function for smooth loading experience
        function startAutoProgress() {
            let stageIndex = 0;

            progressInterval = setInterval(() => {
                if (stageIndex < progressStages.length && !isDataLoaded) {
                    const stage = progressStages[stageIndex];
                    updateProgress(stage.progress, stage.status);
                    stageIndex++;
                }
            }, 600); // Adjust timing as needed
        }

        // Function to hide loading screen
        function hideLoadingScreen() {
            const loadingScreen = document.getElementById('loading-screen');
            if (loadingScreen) {
                loadingScreen.classList.add('hidden');
                // Remove from DOM after transition
                setTimeout(() => {
                    loadingScreen.style.display = 'none';
                }, 500);
            }
        }

        // Start loading progress immediately
        startAutoProgress();

        // Set timeout to hide loading screen after 5-6 seconds
        loadingTimeout = setTimeout(() => {
            if (!isDataLoaded) {
                console.log('Loading screen dismissed by timeout');
                updateProgress(100, "Loading complete");
                setTimeout(hideLoadingScreen, 800);
                clearInterval(progressInterval);
            }
        }, 5500); // 5.5 seconds

        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const commentInput = document.getElementById('commentInput');
            const monthSelect = document.getElementById('monthSelect');
            const file = fileInput.files[0];
            const commentOption = commentInput.value.trim();
            const monthOption = monthSelect.value; // Get the selected month option

            if (!file) {
                document.getElementById('status').textContent = 'No file selected!';
                return;
            }

            // Generate comment based on selected option
            const currentDate = new Date();
            let targetDate = new Date(); // Default to current month

            if (monthOption === 'previous') {
                targetDate.setMonth(currentDate.getMonth() - 1); // Set to previous month
            }

            const targetMonth = ('0' + (targetDate.getMonth() + 1)).slice(-2); // Zero-padded month
            const targetYear = targetDate.getFullYear();

            let comment;
            switch (commentOption) {
                case '01_currentmonth_currentyear-07_currentmonth_currentyear':
                    comment = `01-${targetMonth}-${targetYear} 07-${targetMonth}-${targetYear}`;
                    break;
                case '08_currentmonth_currentyear-15_currentmonth_currentyear':
                    comment = `08-${targetMonth}-${targetYear} 15-${targetMonth}-${targetYear}`;
                    break;
                case '16_currentmonth_currentyear-23_currentmonth_currentyear':
                    comment = `16-${targetMonth}-${targetYear} 23-${targetMonth}-${targetYear}`;
                    break;
                case '24_currentmonth_currentyear-rest':
                    comment = `24-${targetMonth}-${targetYear} rest`;
                    break;
                default:
                    comment = ''; // Handle default case if necessary
                    break;
            }

            if (!comment) {
                document.getElementById('status').textContent = 'Invalid comment option!';
                return;
            }

            // Append comment to file name
            const fileName = `${comment}_bill`;
            const fileRef = ref(storage, `uploads/${fileName}`);

            // Upload the file with progress tracking
            const uploadTask = uploadBytesResumable(fileRef, file);

            const progressBar = document.getElementById('progressBar');
            const progress = document.getElementById('progress');
            const uploadSpeedEl = document.getElementById('uploadSpeed');

            progressBar.style.display = 'block'; // Show progress bar
            uploadSpeedEl.style.display = 'block'; // show speed element
            uploadSpeedEl.textContent = ''; // clear

            // Variables to compute speed
            let uploadStartTime = Date.now();
            let lastTime = uploadStartTime;
            let lastBytes = 0;

            // helper to format bytes nicely
            function formatBytes(bytes) {
                if (!bytes && bytes !== 0) return '';
                if (bytes === 0) return '0 B';
                const k = 1024;
                const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            function humanPerSec(bytesPerSec) {
                if (!bytesPerSec && bytesPerSec !== 0) return '';
                return formatBytes(bytesPerSec);
            }

            uploadTask.on('state_changed',
                (snapshot) => {
                    // Progress function
                    const percentage = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progress.style.width = percentage + '%';

                    // compute speeds
                    const now = Date.now();
                    // delta from last sample
                    const deltaBytes = snapshot.bytesTransferred - lastBytes;
                    const deltaTimeMs = Math.max(now - lastTime, 1);
                    const instantBps = deltaBytes / (deltaTimeMs / 1000); // bytes per second
                    const avgBps = snapshot.bytesTransferred / ((now - uploadStartTime) / 1000 || 1); // bytes/sec

                    lastBytes = snapshot.bytesTransferred;
                    lastTime = now;

                    // Update upload speed display (instant and avg), and bytes transferred / total
                    uploadSpeedEl.textContent = `${formatBytes(snapshot.bytesTransferred)} of ${formatBytes(snapshot.totalBytes)} â€” ${humanPerSec(instantBps)}/s (avg ${humanPerSec(avgBps)}/s)`;
                },
                (error) => {
                    // Error function
                    document.getElementById('status').textContent = 'Upload failed: ' + error.message;
                    console.error('Upload failed:', error);
                    // hide progress UI after short delay
                    setTimeout(() => {
                        progress.style.width = '0%';
                        progressBar.style.display = 'none';
                        uploadSpeedEl.style.display = 'none';
                    }, 1500);
                },
                async () => {
                    // Completion function
                    document.getElementById('status').textContent = 'Upload successful!';
                    // Clear current displayed photos so refresh shows newest items only
                    document.getElementById('displayBox').innerHTML = '';

                    // Reset and reload all photos
                    allItems = [];
                    currentIndex = 0;
                    await loadAllItems();
                    loadMoreItems();

                    // Reset progress bar & speed UI
                    progress.style.width = '0%';
                    setTimeout(() => {
                        progressBar.style.display = 'none'; // Hide progress bar
                        uploadSpeedEl.textContent = 'Upload complete';
                        // hide speed after short pause
                        setTimeout(() => {
                            uploadSpeedEl.style.display = 'none';
                            uploadSpeedEl.textContent = '';
                        }, 1200);
                    }, 400);
                }
            );
        }

        // Function to load all items from Firebase Storage
        async function loadAllItems() {
            try {
                // List all files in the 'uploads' folder
                const listRef = ref(storage, 'uploads/');
                const listResult = await listAll(listRef);

                // Custom sorting function based on date range
                const sortByDateRange = (fileName) => {
                    const dateRangeString = fileName.split('_')[0]; // Assuming date range is at the beginning of the file name
                    const startDateString = dateRangeString.split(' ')[0]; // Get the start date part
                    const [day, month, year] = startDateString.split('-'); // Split by '-' assuming "DD-MM-YYYY" format
                    return new Date(year, month - 1, day); // Return Date object for sorting
                };

                // Sort files based on date range
                allItems = listResult.items.sort((a, b) => {
                    const dateA = sortByDateRange(a.name);
                    const dateB = sortByDateRange(b.name);
                    return dateB - dateA; // Descending order (latest date first)
                });

                // Mark data as loaded
                isDataLoaded = true;
                if (currentProgress < 100) {
                    clearInterval(progressInterval);
                    clearTimeout(loadingTimeout);
                    updateProgress(100, "Complete! Ready to upload files.");
                    setTimeout(hideLoadingScreen, 800);
                }
            } catch (error) {
                console.error('Error loading photos:', error);
                isDataLoaded = true;
                clearTimeout(loadingTimeout);
                updateProgress(100, "Error loading files");
                setTimeout(hideLoadingScreen, 800);
            }
        }

        // Function to load more items (for infinite scroll)
        async function loadMoreItems() {
            if (isLoading || currentIndex >= allItems.length) return;

            isLoading = true;
            const scrollLoader = document.getElementById('scrollLoader');
            scrollLoader.style.display = 'block';

            const endIndex = Math.min(currentIndex + itemsPerLoad, allItems.length);

            for (let i = currentIndex; i < endIndex; i++) {
                const itemRef = allItems[i];
                try {
                    const url = await getDownloadURL(itemRef);

                    const photoBox = document.createElement('div');
                    photoBox.classList.add('photoBox');

                    const imgElement = document.createElement('img');
                    imgElement.src = url;
                    imgElement.loading = "lazy"; // Enable native lazy loading

                    const fileName = document.createElement('p');
                    fileName.classList.add('comment');
                    fileName.textContent = itemRef.name.split('_')[0].replace(/_/g, ' '); // Display comment as formatted string

                    const downloadButton = document.createElement('button');
                    downloadButton.classList.add('downloadButton');
                    downloadButton.textContent = 'Download';
                    downloadButton.addEventListener('click', () => {
                        downloadFile(url, itemRef.name);
                    });

                    photoBox.appendChild(imgElement);
                    photoBox.appendChild(fileName);
                    photoBox.appendChild(downloadButton);
                    document.getElementById('displayBox').appendChild(photoBox);
                } catch (error) {
                    console.error('Error getting download URL:', error);
                }
            }

            currentIndex = endIndex;
            isLoading = false;
            scrollLoader.style.display = 'none';

            // If we've loaded all items, hide the loader
            if (currentIndex >= allItems.length) {
                scrollLoader.style.display = 'none';
            }
        }

        // Function to handle scroll events for infinite loading
        function handleScroll() {
            const scrollLoader = document.getElementById('scrollLoader');
            if (isLoading || currentIndex >= allItems.length) {
                return;
            }

            // Check if we're near the bottom of the page
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
                loadMoreItems();
            }
        }

        // Add scroll event listener
        window.addEventListener('scroll', handleScroll);

        function downloadFile(url, fileName) {
            fetch(url)
                .then(response => response.blob())
                .then(blob => {
                    const blobUrl = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.style.display = 'none';
                    a.href = blobUrl;
                    a.download = fileName; // Set the file name for download
                    document.body.appendChild(a);
                    a.click(); // Simulate click on the anchor tag
                    document.body.removeChild(a); // Clean up
                    URL.revokeObjectURL(blobUrl); // Clean up the Blob URL
                })
                .catch(error => {
                    console.error('Error downloading file:', error);
                });
        }

        // Event listener for the upload button
        const uploadButton = document.getElementById('uploadButton');
        uploadButton.addEventListener('click', uploadFile);

        // Load all items on initial load, then load the first batch
        window.onload = function () {
            loadAllItems().then(() => {
                loadMoreItems();
            });
        };

        onAuthStateChanged(auth, (user) => {
            const content_box = document.getElementById('content_box');

            if (user) {
                content_box.classList.remove('disabled');
            } else {
                content_box.classList.add('disabled');
            }
        });

    </script>
</body>

</html>
