<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fix Database</title>
</head>
<style>
    :root {
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --text-primary: #e0e0e0;
        --text-secondary: #a0a0a0;
        --accent-color: #bb86fc;
        --danger-color: #cf6679;
        --success-color: #03dac6;
        --border-color: #333;
        --input-bg: #2d2d2d;
    }
    
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-primary);
        margin: 0;
        padding: 0;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        min-height: 100vh;
        padding: 20px;
        box-sizing: border-box;
    }
    
    #container {
        width: 100%;
        max-width: 400px;
        position: relative;
        transition: box-shadow 0.3s;
    }
    
    #container.success {
        animation: flicker 0.5s linear 10;
    }
    
    @keyframes flicker {
        0% { box-shadow: 0 0 0 0 rgba(3, 218, 198, 0); }
        50% { box-shadow: 0 0 0 4px rgba(3, 218, 198, 0.5); }
        100% { box-shadow: 0 0 0 0 rgba(3, 218, 198, 0); }
    }
    
    #backtomain {
        position: absolute;
        right: 0;
        top: 0;
        padding: 8px 12px;
        background-color: var(--danger-color);
        color: white;
        border: none;
        border-radius: 4px;
        font-size: 14px;
        cursor: pointer;
        z-index: 10;
    }
    
    #form-box {
        background-color: var(--card-bg);
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        width: 100%;
        margin-top: 40px;
    }
    
    .title {
        margin: 0 0 20px 0;
        font-size: 24px;
        font-weight: bold;
        color: var(--accent-color);
        text-align: center;
    }
    
    form {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .form-group {
        display: flex;
        flex-direction: column;
        gap: 4px;
        flex: 1;
        min-width: 0;
    }
    
    label {
        font-size: 14px;
        color: var(--text-secondary);
    }
    
    select, input {
        padding: 10px;
        background-color: var(--input-bg);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-size: 14px;
        width: 100%;
        box-sizing: border-box;
    }
    
    select {
        appearance: none;
        -webkit-appearance: none;
        background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='white'%3e%3cpath d='M7 10l5 5 5-5z'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 10px center;
        background-size: 12px;
    }
    
    .input-row {
        display: flex;
        gap: 10px;
    }

    /* Tiny preview chips under inputs */
    .preview-chip {
        font-size: 12px;
        color: var(--text-secondary);
        margin-top: 4px;
        user-select: none;
    }
    
    .submit-btn {
        background-color: var(--accent-color);
        color: #000;
        padding: 12px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: bold;
        font-size: 16px;
        margin-top: 10px;
        transition: background-color 0.2s;
    }
    
    .submit-btn:hover {
        background-color: #9c64f4;
    }
    
    .alert {
        display: none;
        background-color: var(--success-color);
        color: #000;
        padding: 12px;
        border-radius: 4px;
        margin-top: 15px;
        text-align: center;
        font-weight: bold;
    }
    
    .alert.show {
        display: block;
        animation: fadeInOut 3s forwards;
    }
    
    @keyframes fadeInOut {
        0% { opacity: 0; }
        20% { opacity: 1; }
        80% { opacity: 1; }
        100% { opacity: 0; }
    }
    
    /* Small screen adjustments */
    @media (max-width: 480px) {
        body {
            padding: 10px;
        }
        
        #form-box {
            padding: 15px;
        }
        
        .title {
            font-size: 20px;
        }
        
        /* Keep KG, FAT, SNF in one row */
        .input-row.equal-3 {
            display: flex;
            gap: 8px;
        }
        .input-row.equal-3 .form-group {
            flex: 1;
        }

        /* Keep Rate, Total in one row */
        .input-row.equal-2 {
            display: flex;
            gap: 8px;
        }
        .input-row.equal-2 .form-group {
            flex: 1;
        }
    }
</style>

<body>
    <div id="container">
        <button id="backtomain">Back to Main</button>
        <div id="form-box">
            <form action="" name="lol" method="post" id="registrationform">
                <div class="title">Fix Database</div>

                <div class="input-row">
                    <div class="form-group">
                        <label for="customDate">Date</label>
                        <input type="date" id="customDate" name="customDate" required>
                        <!-- dd/mm/yy preview -->
                        <span class="preview-chip" id="datePreview">--/--/--</span>
                    </div>
                    <div class="form-group">
                        <label for="customTime">Time</label>
                        <input type="time" id="customTime" name="customTime" required>
                        <!-- hh:mm am/pm preview -->
                        <span class="preview-chip" id="timePreview">--:--</span>
                    </div>
                </div>

                <div class="form-group">
                    <label for="name">সদস্যর নাম</label>
                    <select id="name" name="NAME" required>
                        <option value=""></option>
                    </select>
                </div>

                <!-- KG, FAT, SNF same row -->
                <div class="input-row equal-3">
                    <div class="form-group">
                        <label for="kg">KG</label>
                        <input type="number" placeholder="Kg" id="kg" step="any" required oninput="rateandtotal();">
                    </div>
                    <div class="form-group">
                        <label for="fat">FAT</label>
                        <input type="number" placeholder="FAT" id="fat" step="any" oninput="rateandtotal();">
                    </div>
                    <div class="form-group">
                        <label for="snf">SNF</label>
                        <input type="number" placeholder="SNF" id="snf" step="any" required oninput="rateandtotal();">
                    </div>
                </div>

                <!-- Rate, Total same row -->
                <div class="input-row equal-2">
                    <div class="form-group">
                        <label for="rate">Rate</label>
                        <input type="number" id="rate" step="any" required>
                    </div>
                    <div class="form-group">
                        <label for="total">Total</label>
                        <input type="number" id="total" step="any" required>
                    </div>
                </div>

                <div class="alert">Data submitted successfully!</div>
                <button type="submit" id="submit" class="submit-btn">Calculate</button>
            </form>
        </div>
    </div>
   
    <script>
        async function fetchNames() {
            try {
                const response = await fetch('name.md');
                const data = await response.text();
                const names = data.split('\n').map(line => line.split(' | ')[0].trim()).filter(Boolean);

                const nameSelect = document.getElementById('name');
                names.forEach(name => {
                    const option = document.createElement('option');
                    option.value = name;
                    option.text = name;
                    nameSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error fetching names:', error);
            }
        }

        // --- Helpers for date/time previews ---
        function pad2(n){ return String(n).padStart(2,'0'); }

        function formatDDMMYYFromYMD(ymd){
            // ymd = "YYYY-MM-DD"
            if(!ymd) return '--/--/--';
            const [y,m,d] = ymd.split('-');
            if(!(y && m && d)) return '--/--/--';
            return `${pad2(d)}/${pad2(m)}/${String(y).slice(-2)}`;
        }

        function formatTime12FromHM(hm){
            // hm = "HH:MM"
            if(!hm) return '--:--';
            const [H,M] = hm.split(':').map(x=>parseInt(x,10));
            if(Number.isNaN(H) || Number.isNaN(M)) return '--:--';
            const ampm = H >= 12 ? 'pm' : 'am';
            const h12 = (H % 12) || 12;
            return `${pad2(h12)}:${pad2(M)}${ampm}`;
        }

        function setDefaultDateTime(){
            const now = new Date();
            const yyyy = now.getFullYear();
            const mm = pad2(now.getMonth()+1);
            const dd = pad2(now.getDate());
            const HH = pad2(now.getHours());
            const MM = pad2(now.getMinutes());

            const dateInput = document.getElementById('customDate');
            const timeInput = document.getElementById('customTime');

            // Set native input values (required for proper form handling)
            dateInput.value = `${yyyy}-${mm}-${dd}`;
            timeInput.value = `${HH}:${MM}`;

            // Update the human-readable previews
            updateDatePreview();
            updateTimePreview();
        }

        function updateDatePreview(){
            const dateInput = document.getElementById('customDate');
            const datePreview = document.getElementById('datePreview');
            datePreview.textContent = formatDDMMYYFromYMD(dateInput.value);
        }

        function updateTimePreview(){
            const timeInput = document.getElementById('customTime');
            const timePreview = document.getElementById('timePreview');
            timePreview.textContent = formatTime12FromHM(timeInput.value);
        }

        // Keep your original on DOMContentLoaded behavior and add defaults + preview bindings
        document.addEventListener('DOMContentLoaded', () => {
            fetchNames();
            setDefaultDateTime();

            document.getElementById('customDate').addEventListener('input', updateDatePreview);
            document.getElementById('customDate').addEventListener('change', updateDatePreview);

            document.getElementById('customTime').addEventListener('input', updateTimePreview);
            document.getElementById('customTime').addEventListener('change', updateTimePreview);
        });
    </script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-app.js";
        import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-database.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.9.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAuhNKygw6dv8jqfNY8qnmIrX-TsLy2jvI",
            authDomain: "dairy-app-abhijit.firebaseapp.com",
            databaseURL: "https://dairy-app-abhijit-default-rtdb.firebaseio.com",
            projectId: "dairy-app-abhijit",
            storageBucket: "dairy-app-abhijit.appspot.com",
            messagingSenderId: "196152880143",
            appId: "1:196152880143:web:bec02170e30932a7d5877a"
        };
        
        const app = initializeApp(firebaseConfig);
        const database = getDatabase();
        const auth = getAuth();

        document.getElementById('registrationform').addEventListener('submit', formSubmit);

        function formSubmit(e) {
            e.preventDefault();
            if (validateInput()) {
                let name = document.querySelector('#name').value;
                let rate = document.querySelector('#rate').value;
                let total = document.querySelector('#total').value;
                let fat = document.querySelector('#fat').value;
                let snf = document.querySelector('#snf').value;
                let kg = document.querySelector('#kg').value;
                let customDate = document.querySelector('#customDate').value;
                let customTime = document.querySelector('#customTime').value;

                let selectedDate = new Date(customDate + 'T' + customTime);
                checkAndSendMessage(name, rate, total, fat, snf, kg, selectedDate);
            } else {
                console.log("Form validation failed. Please correct errors.");
            }
        }

        function validateInput() {
            // Implement validation logic if necessary
            return true;
        }

        function formatDateTime(date) {
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const meridiem = hours >= 12 ? 'pm' : 'am';
            const formattedHours = hours % 12 || 12;
            return `${day}/${month}/${year} ${formattedHours}:${minutes}${meridiem}`;
        }

        function getTimePeriod(hours) {
            if (hours >= 3 && hours < 11) {
                return "সকাল";
            } else if (hours >= 12 && hours < 15) {
                return "দুপুর";
            } else {
                return "সন্ধ্যা";
            }
        }

        async function checkAndSendMessage(name, rate, total, fat, snf, kg, selectedDate) {
            const formattedDate = `${selectedDate.getDate()}-${selectedDate.getMonth() + 1}-${selectedDate.getFullYear()}`;
            const formattedTime = formatDateTime(selectedDate);
            const personName = name.toLowerCase().replace(/\s+/g, '-');
            const timePeriod = getTimePeriod(selectedDate.getHours());
            const personRef = ref(database, `records/${formattedDate}/${personName}/${timePeriod}`);

            try {
                await set(personRef, {
                    name: name,
                    rate: rate,
                    total: total,
                    fat: fat,
                    snf: snf,
                    kg: kg,
                    timestamp: formattedTime
                });
                
                // Show success effects
                document.querySelector('.alert').classList.add('show');
                const container = document.getElementById('container');
                container.classList.add('success');
                
                setTimeout(function () {
                    document.querySelector('.alert').classList.remove('show');
                    container.classList.remove('success');
                }, 3000);
            } catch (error) {
                alert(error);
            }
        }
    </script>

    <script>
        document.getElementById('backtomain').addEventListener('click', function() {
            window.location.href = 'index.html';
        });

        function playSound() {
            const audio = new Audio('button.wav');
            audio.play().catch(e => console.log("Audio play failed:", e));
        }

        function rateandtotal() {
            // Implement your rate calculation logic here
        }

        function multiplyNumbers() {
            // Implement your multiplication logic here
        }
    </script>
    <script src="js/rate.js?v=1.0.2"></script>
</body>
</html>
